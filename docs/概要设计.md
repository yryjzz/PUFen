# PUFen ç§¯åˆ†ç­¾åˆ°ç³»ç»Ÿ - æ¦‚è¦è®¾è®¡æ–‡æ¡£

### ç‚¹å‡»è®¿é—®ğŸ‘‰
- https://pu-fen-amber.vercel.app

## ä¸€ã€æŠ€æœ¯é€‰å‹

### å‰ç«¯æŠ€æœ¯æ ˆ
**ç¼–ç¨‹è¯­è¨€**
- TypeScript 5.x - å¼ºç±»å‹è¯­è¨€ï¼Œæä¾›æ›´å¥½çš„å¼€å‘ä½“éªŒå’Œä»£ç è´¨é‡

**æ¡†æ¶ä¸åº“**
- React 18 - ç°ä»£åŒ–å‰ç«¯æ¡†æ¶ï¼Œæ”¯æŒå¹¶å‘ç‰¹æ€§
- Vite - å¿«é€Ÿæ„å»ºå·¥å…·ï¼Œçƒ­æ›´æ–°å’Œä¼˜åŒ–æ‰“åŒ…
- React Router DOM - å®¢æˆ·ç«¯è·¯ç”±ç®¡ç†
- Ant Design - ä¼ä¸šçº§UIç»„ä»¶åº“
- Styled Components - CSS-in-JSæ ·å¼è§£å†³æ–¹æ¡ˆ

**çŠ¶æ€ç®¡ç†**
- Zustand - è½»é‡çº§çŠ¶æ€ç®¡ç†åº“ï¼Œç®€å•æ˜“ç”¨
- React Hooks - åŸç”ŸçŠ¶æ€ç®¡ç†

**å·¥å…·åº“**
- Axios - HTTPå®¢æˆ·ç«¯ï¼ŒAPIè¯·æ±‚å¤„ç†
- Day.js - è½»é‡çº§æ—¥æœŸå¤„ç†åº“
- React Query (å¯é€‰) - æœåŠ¡ç«¯çŠ¶æ€ç®¡ç†

**ç§»åŠ¨ç«¯ä¼˜åŒ–**
- PWA - æ¸è¿›å¼Webåº”ç”¨
- è§¦æ‘¸äº‹ä»¶å¤„ç† - ç§»åŠ¨ç«¯äº¤äº’ä¼˜åŒ–
- æŒ¯åŠ¨API - åŸç”Ÿä½“éªŒå¢å¼º
- Web Share API - åŸç”Ÿåˆ†äº«åŠŸèƒ½

### åç«¯æŠ€æœ¯æ ˆ
**ç¼–ç¨‹è¯­è¨€**
- Node.js 18+ - JavaScriptè¿è¡Œæ—¶
- TypeScript 5.x - ç±»å‹å®‰å…¨çš„æœåŠ¡ç«¯å¼€å‘

**Webæ¡†æ¶**
- Fastify 5.x - é«˜æ€§èƒ½Webæ¡†æ¶ï¼Œæ¯”Expressæ›´å¿«
- Fastifyæ’ä»¶ç”Ÿæ€ - CORSã€èº«ä»½éªŒè¯ç­‰

**æ•°æ®åº“**
- SQLite - è½»é‡çº§å…³ç³»å‹æ•°æ®åº“ï¼Œé€‚åˆä¸­å°å‹åº”ç”¨
- TypeORM 0.3.x - TypeScript ORMï¼Œæ•°æ®åº“æŠ½è±¡å±‚

**èº«ä»½éªŒè¯**
- JWT (jsonwebtoken) - æ— çŠ¶æ€èº«ä»½éªŒè¯
- bcrypt - å¯†ç åŠ å¯†å“ˆå¸Œ

**å·¥å…·åº“**
- date-fns - æ—¥æœŸå¤„ç†å·¥å…·
- node-cron - å®šæ—¶ä»»åŠ¡è°ƒåº¦
- reflect-metadata - è£…é¥°å™¨å…ƒæ•°æ®æ”¯æŒ

### å¼€å‘å·¥å…·
**æ„å»ºå·¥å…·**
- tsx - TypeScriptæ‰§è¡Œå™¨
- tsc - TypeScriptç¼–è¯‘å™¨
- nodemon - å¼€å‘çƒ­é‡è½½

**ä»£ç è´¨é‡**
- ESLint - ä»£ç è´¨é‡æ£€æŸ¥
- Prettier - ä»£ç æ ¼å¼åŒ–
- TypeScriptä¸¥æ ¼æ¨¡å¼ - ç±»å‹æ£€æŸ¥

### éƒ¨ç½²æ¶æ„
**å‰ç«¯éƒ¨ç½²**
- Vercel - é™æ€ç«™ç‚¹æ‰˜ç®¡ï¼Œè‡ªåŠ¨CI/CD
- CDNåŠ é€Ÿ - å…¨çƒå†…å®¹åˆ†å‘

**åç«¯éƒ¨ç½²**
- Render - å®¹å™¨åŒ–éƒ¨ç½²å¹³å°
- Docker - å®¹å™¨åŒ–æ‰“åŒ…
- è‡ªåŠ¨æ‰©ç¼©å®¹ - æ ¹æ®è´Ÿè½½è‡ªåŠ¨è°ƒæ•´

**æ•°æ®æŒä¹…åŒ–**
- æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ - SQLiteæ•°æ®åº“æ–‡ä»¶
- å®šæœŸå¤‡ä»½ - æ•°æ®å®‰å…¨ä¿éšœ

## äºŒã€ç³»ç»Ÿæ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯åº”ç”¨        â”‚    â”‚   åç«¯API        â”‚    â”‚   æ•°æ®åº“å±‚       â”‚
â”‚   (React SPA)   â”‚â—„â”€â”€â–ºâ”‚   (Fastify)     â”‚â—„â”€â”€â–ºâ”‚   (SQLite)      â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â€¢ ç”¨æˆ·ç•Œé¢       â”‚    â”‚ â€¢ RESTful API   â”‚    â”‚ â€¢ ç”¨æˆ·æ•°æ®       â”‚
â”‚ â€¢ çŠ¶æ€ç®¡ç†       â”‚    â”‚ â€¢ èº«ä»½éªŒè¯       â”‚    â”‚ â€¢ ç§¯åˆ†è®°å½•       â”‚
â”‚ â€¢ è·¯ç”±æ§åˆ¶       â”‚    â”‚ â€¢ ä¸šåŠ¡é€»è¾‘       â”‚    â”‚ â€¢ ç­¾åˆ°æ•°æ®       â”‚
â”‚ â€¢ ç§»åŠ¨ç«¯ä¼˜åŒ–     â”‚    â”‚ â€¢ å®šæ—¶ä»»åŠ¡       â”‚    â”‚ â€¢ å›¢é˜Ÿä¿¡æ¯       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‰ç«¯æ¶æ„
```
src/
â”œâ”€â”€ components/          # å¯å¤ç”¨ç»„ä»¶
â”‚   â”œâ”€â”€ mobile.tsx      # ç§»åŠ¨ç«¯ç»„ä»¶(ä¸‹æ‹‰åˆ·æ–°ã€å®‰å…¨åŒºåŸŸ)
â”‚   â”œâ”€â”€ ProtectedRoute.tsx # è·¯ç”±å®ˆå«
â”‚   â””â”€â”€ styled.tsx      # é€šç”¨æ ·å¼ç»„ä»¶
â”œâ”€â”€ pages/              # é¡µé¢ç»„ä»¶
â”‚   â”œâ”€â”€ Login.tsx       # ç™»å½•é¡µé¢
â”‚   â”œâ”€â”€ Register.tsx    # æ³¨å†Œé¡µé¢
â”‚   â”œâ”€â”€ Points.tsx      # ç§¯åˆ†ä¸»é¡µ(ç­¾åˆ°æ—¥å†ã€ç§¯åˆ†å±•ç¤º)
â”‚   â”œâ”€â”€ InviteFriend.tsx # å›¢é˜Ÿé‚€è¯·é¡µé¢
â”‚   â”œâ”€â”€ Records.tsx     # è®°å½•é¡µé¢(ç§¯åˆ†ã€ç­¾åˆ°ã€å›¢é˜Ÿè®°å½•)
â”‚   â”œâ”€â”€ Coupons.tsx     # ä¼˜æƒ åˆ¸é¡µé¢
â”‚   â”œâ”€â”€ Rules.tsx       # è§„åˆ™è¯´æ˜é¡µé¢
â”‚   â”œâ”€â”€ Profile.tsx     # ä¸ªäººä¸­å¿ƒ
â”‚   â””â”€â”€ MobileDemo.tsx  # ç§»åŠ¨ç«¯åŠŸèƒ½æ¼”ç¤º
â”œâ”€â”€ services/           # APIæœåŠ¡å±‚
â”‚   â”œâ”€â”€ api.ts         # åŸºç¡€APIé…ç½®
â”‚   â”œâ”€â”€ auth.ts        # è®¤è¯ç›¸å…³API
â”‚   â”œâ”€â”€ points.ts      # ç§¯åˆ†ç›¸å…³API
â”‚   â”œâ”€â”€ team.ts        # å›¢é˜Ÿç›¸å…³API
â”‚   â”œâ”€â”€ reward.ts      # å¥–åŠ±ç›¸å…³API
â”‚   â””â”€â”€ coupon.ts      # ä¼˜æƒ åˆ¸ç›¸å…³API
â”œâ”€â”€ store/              # çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ auth.ts        # è®¤è¯çŠ¶æ€(ç”¨æˆ·ä¿¡æ¯ã€ç™»å½•çŠ¶æ€)
â”‚   â””â”€â”€ points.ts      # ç§¯åˆ†çŠ¶æ€(ç§¯åˆ†è´¦æˆ·ã€ç­¾åˆ°é…ç½®)
â”œâ”€â”€ types/              # ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ index.ts       # å…¨å±€ç±»å‹å£°æ˜
â”œâ”€â”€ utils/              # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ common.ts      # é€šç”¨å·¥å…·
â”‚   â”œâ”€â”€ date.ts        # æ—¥æœŸå¤„ç†
â”‚   â”œâ”€â”€ mobile.ts      # ç§»åŠ¨ç«¯å·¥å…·(è®¾å¤‡æ£€æµ‹ã€æŒ¯åŠ¨ã€åˆ†äº«)
â”‚   â””â”€â”€ share.ts       # åˆ†äº«åŠŸèƒ½
â””â”€â”€ styles/             # æ ·å¼æ–‡ä»¶
    â”œâ”€â”€ mobile.css     # ç§»åŠ¨ç«¯æ ·å¼
    â””â”€â”€ invite-friend.css # é‚€è¯·é¡µé¢æ ·å¼
```

### åç«¯æ¶æ„
```
src/
â”œâ”€â”€ app.ts              # Fastifyåº”ç”¨é…ç½®
â”œâ”€â”€ server.ts           # æœåŠ¡å™¨å¯åŠ¨å…¥å£
â”œâ”€â”€ config/
â”‚   â””â”€â”€ db.ts          # æ•°æ®åº“é…ç½®(TypeORM DataSource)
â”œâ”€â”€ controllers/        # æ§åˆ¶å™¨å±‚(å¤„ç†HTTPè¯·æ±‚)
â”‚   â”œâ”€â”€ auth.controller.ts    # è®¤è¯æ§åˆ¶å™¨(æ³¨å†Œã€ç™»å½•)
â”‚   â”œâ”€â”€ points.controller.ts  # ç§¯åˆ†æ§åˆ¶å™¨(è´¦æˆ·ã€è®°å½•)
â”‚   â”œâ”€â”€ signin.controller.ts  # ç­¾åˆ°æ§åˆ¶å™¨(ç­¾åˆ°ã€çŠ¶æ€)
â”‚   â”œâ”€â”€ team.controller.ts    # å›¢é˜Ÿæ§åˆ¶å™¨(åˆ›å»ºã€åŠ å…¥)
â”‚   â”œâ”€â”€ reward.controller.ts  # å¥–åŠ±æ§åˆ¶å™¨(å•†å“ã€å…‘æ¢)
â”‚   â””â”€â”€ coupon.controller.ts  # ä¼˜æƒ åˆ¸æ§åˆ¶å™¨(å‘æ”¾ã€æŸ¥è¯¢)
â”œâ”€â”€ entities/           # æ•°æ®å®ä½“(TypeORM Entity)
â”‚   â”œâ”€â”€ User.ts               # ç”¨æˆ·å®ä½“
â”‚   â”œâ”€â”€ PointsAccount.ts      # ç§¯åˆ†è´¦æˆ·å®ä½“
â”‚   â”œâ”€â”€ SignInRecord.ts       # ç­¾åˆ°è®°å½•å®ä½“
â”‚   â”œâ”€â”€ SignInConfig.ts       # ç­¾åˆ°é…ç½®å®ä½“
â”‚   â”œâ”€â”€ Team.ts               # å›¢é˜Ÿå®ä½“
â”‚   â”œâ”€â”€ TeamMember.ts         # å›¢é˜Ÿæˆå‘˜å®ä½“
â”‚   â”œâ”€â”€ TeamRecord.ts         # å›¢é˜Ÿè®°å½•å®ä½“
â”‚   â”œâ”€â”€ RewardItem.ts         # å¥–åŠ±å•†å“å®ä½“
â”‚   â”œâ”€â”€ RewardRecord.ts       # å…‘æ¢è®°å½•å®ä½“
â”‚   â”œâ”€â”€ UserCoupon.ts         # ç”¨æˆ·ä¼˜æƒ åˆ¸å®ä½“
â”‚   â””â”€â”€ PointsTransaction.ts  # ç§¯åˆ†äº¤æ˜“å®ä½“
â”œâ”€â”€ services/           # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ signin-config.service.ts # ç­¾åˆ°é…ç½®æœåŠ¡
â”‚   â”œâ”€â”€ reward-list.service.ts   # å¥–åŠ±åˆ—è¡¨æœåŠ¡
â”‚   â”œâ”€â”€ reward-stage.service.ts  # å¥–åŠ±é˜¶æ®µæœåŠ¡
â”‚   â””â”€â”€ coupon-expiry.service.ts # ä¼˜æƒ åˆ¸è¿‡æœŸæœåŠ¡
â”œâ”€â”€ tasks/              # å®šæ—¶ä»»åŠ¡
â”‚   â”œâ”€â”€ signin.task.ts         # ç­¾åˆ°ç›¸å…³å®šæ—¶ä»»åŠ¡
â”‚   â””â”€â”€ coupon-expiry.task.ts  # ä¼˜æƒ åˆ¸è¿‡æœŸä»»åŠ¡
â”œâ”€â”€ middleware/         # ä¸­é—´ä»¶
â”‚   â””â”€â”€ auth.hook.ts    # èº«ä»½éªŒè¯ä¸­é—´ä»¶
â”œâ”€â”€ scripts/            # è„šæœ¬å·¥å…·
â”‚   â”œâ”€â”€ userCli.ts      # ç”¨æˆ·ç®¡ç†è„šæœ¬
â”‚   â”œâ”€â”€ coupon-cli.ts   # ä¼˜æƒ åˆ¸ç®¡ç†è„šæœ¬
â”‚   â””â”€â”€ add-points.ts   # ç§¯åˆ†æ“ä½œè„šæœ¬
â”œâ”€â”€ types/              # ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ fastify.d.ts    # Fastifyç±»å‹æ‰©å±•
â””â”€â”€ utils/              # å·¥å…·å‡½æ•°
    â”œâ”€â”€ jwt.ts          # JWTå·¥å…·
    â””â”€â”€ password.ts     # å¯†ç åŠ å¯†å·¥å…·
```

## ä¸‰ã€æ•°æ®åº“è®¾è®¡

### æ•°æ®åº“é€‰å‹è¯´æ˜
é€‰æ‹©SQLiteä½œä¸ºæ•°æ®åº“çš„åŸå› ï¼š
1. **è½»é‡çº§**: æ— éœ€ç‹¬ç«‹æœåŠ¡å™¨ï¼Œé™ä½éƒ¨ç½²å¤æ‚åº¦
2. **é«˜æ€§èƒ½**: å¯¹äºä¸­å°å‹åº”ç”¨ï¼Œæ€§èƒ½å®Œå…¨æ»¡è¶³éœ€æ±‚
3. **é›¶é…ç½®**: æ–‡ä»¶å‹æ•°æ®åº“ï¼Œæ˜“äºå¤‡ä»½å’Œè¿ç§»
4. **äº‹åŠ¡æ”¯æŒ**: å®Œæ•´çš„ACIDäº‹åŠ¡æ”¯æŒ
5. **æˆæœ¬æ•ˆç›Š**: å‡å°‘æ•°æ®åº“æœåŠ¡å™¨æˆæœ¬

### å®ä½“å…³ç³»è®¾è®¡

#### 1. ç”¨æˆ·è¡¨(User)
```typescript
@Entity()
export class User {
  @PrimaryGeneratedColumn('uuid')
  id: string; // ä¸»é”®ï¼ŒUUIDç¡®ä¿å…¨å±€å”¯ä¸€

  @Column({ length: 50 })
  username: string; // ç”¨æˆ·æ˜µç§°ï¼Œé•¿åº¦é™åˆ¶50å­—ç¬¦

  @Column({ length: 20, unique: true })
  phone: string; // æ‰‹æœºå·ï¼Œå”¯ä¸€ç´¢å¼•ç”¨äºç™»å½•

  @Column()
  password: string; // bcryptåŠ å¯†å¯†ç 

  @Column({ default: true })
  isNewUser: boolean; // æ–°ç”¨æˆ·æ ‡è¯†ï¼Œå½±å“å›¢é˜Ÿå¥–åŠ±

  @CreateDateColumn()
  createdAt: Date; // è‡ªåŠ¨è®°å½•åˆ›å»ºæ—¶é—´

  @UpdateDateColumn()
  updatedAt: Date; // è‡ªåŠ¨è®°å½•æ›´æ–°æ—¶é—´
}
```

#### 2. ç§¯åˆ†è´¦æˆ·è¡¨(PointsAccount)
```typescript
@Entity()
export class PointsAccount {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  userId: string; // å…³è”ç”¨æˆ·IDï¼Œä¸€å¯¹ä¸€å…³ç³»

  @Column({ default: 0 })
  balance: number; // å½“å‰å¯ç”¨ç§¯åˆ†ä½™é¢

  @Column({ default: 0 })
  totalEarned: number; // å†å²ç´¯è®¡è·å¾—ç§¯åˆ†

  @Column({ default: 0 })
  totalUsed: number; // å†å²ç´¯è®¡ä½¿ç”¨ç§¯åˆ†

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;
}
```

#### 3. ç­¾åˆ°é…ç½®è¡¨(SignInConfig)
```typescript
@Entity()
export class SignInConfig {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  weekStartDate: Date; // æœ¬å‘¨å¼€å§‹æ—¥æœŸ(å‘¨ä¸€)

  @Column({ default: 10 })
  basePoints: number; // åŸºç¡€ç§¯åˆ†ï¼Œå›ºå®š10åˆ†

  // æ¯æ—¥ç§¯åˆ†å€æ•°é…ç½®
  @Column({ type: 'float', default: 1.0 })
  day1Multiplier: number; // å‘¨ä¸€: 1.0å€ (10åˆ†)

  @Column({ type: 'float' })
  day2Multiplier: number; // å‘¨äºŒ: 1.0æˆ–1.5å€éšæœº

  @Column({ type: 'float' })
  day3Multiplier: number; // å‘¨ä¸‰: 1.0æˆ–1.5å€éšæœº

  @Column({ type: 'float' })
  day4Multiplier: number; // å‘¨å››: 1.0æˆ–1.5å€éšæœº

  @Column({ type: 'float' })
  day5Multiplier: number; // å‘¨äº”: 1.0æˆ–1.5å€éšæœº

  @Column({ type: 'float', default: 0.6 })
  day6Multiplier: number; // å‘¨å…­: 0.6å€ (6åˆ†)

  @Column({ type: 'float', default: 2.0 })
  day7Multiplier: number; // å‘¨æ—¥: 2.0å€ (20åˆ†)

  @Column()
  bonusDay: number; // è¿ç»­ç­¾åˆ°å¥–åŠ±æ—¥(3-5éšæœº)

  @Column()
  bonusCoupon: string; // å¥–åŠ±ä¼˜æƒ åˆ¸ç±»å‹

  @CreateDateColumn()
  createdAt: Date;
}
```

#### 4. ç­¾åˆ°è®°å½•è¡¨(SignInRecord)
```typescript
@Entity()
export class SignInRecord {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  userId: string; // å…³è”ç”¨æˆ·ID

  @Column()
  signInDate: Date; // ç­¾åˆ°æ—¥æœŸ

  @Column()
  dayOfWeek: number; // æ˜ŸæœŸå‡ (1-7)

  @Column()
  pointsEarned: number; // è·å¾—çš„ç§¯åˆ†

  @Column({ type: 'float' })
  multiplier: number; // ä½¿ç”¨çš„å€æ•°

  @Column({ default: false })
  isBonus: boolean; // æ˜¯å¦ä¸ºå¥–åŠ±æ—¥

  @Column({ default: false })
  isMakeUp: boolean; // æ˜¯å¦ä¸ºè¡¥ç­¾

  @Column({ default: 0 })
  makeUpCost: number; // è¡¥ç­¾æ¶ˆè€—ç§¯åˆ†

  @CreateDateColumn()
  createdAt: Date;
}
```

#### 5. å›¢é˜Ÿè¡¨(Team)
```typescript
@Entity()
export class Team {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  captainId: string; // é˜Ÿé•¿ç”¨æˆ·ID

  @Column({ length: 50 })
  name: string; // å›¢é˜Ÿåç§°

  @Column({ length: 10, unique: true, nullable: true })
  inviteCode: string; // é‚€è¯·ç ï¼Œ10ä½éšæœºå­—ç¬¦

  @Column()
  startTime: Date; // å›¢é˜Ÿåˆ›å»ºæ—¶é—´

  @Column()
  endTime: Date; // å›¢é˜Ÿç»“æŸæ—¶é—´(åˆ›å»ºæ—¶é—´+3å°æ—¶)

  @Column({ default: 100 })
  totalPoints: number; // æ€»ç§¯åˆ†æ± ï¼Œå›ºå®š100åˆ†

  @Column({
    type: 'varchar',
    length: 20,
    default: 'active'
  })
  status: 'active' | 'completed' | 'expired'; // å›¢é˜ŸçŠ¶æ€

  @CreateDateColumn()
  createdAt: Date;
}
```

#### 6. å›¢é˜Ÿæˆå‘˜è¡¨(TeamMember)
```typescript
@Entity()
export class TeamMember {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  teamId: string; // å…³è”å›¢é˜ŸID

  @Column()
  userId: string; // å…³è”ç”¨æˆ·ID

  @Column({
    type: 'varchar',
    length: 10
  })
  role: 'captain' | 'member'; // æˆå‘˜è§’è‰²

  @Column()
  isNewUser: boolean; // åŠ å…¥æ—¶æ˜¯å¦ä¸ºæ–°ç”¨æˆ·

  @Column()
  pointsEarned: number; // è¯¥æˆå‘˜è·å¾—çš„ç§¯åˆ†

  @Column()
  joinedAt: Date; // åŠ å…¥å›¢é˜Ÿæ—¶é—´

  @CreateDateColumn()
  createdAt: Date;
}
```

#### 7. å¥–åŠ±å•†å“è¡¨(RewardItem)
```typescript
@Entity()
export class RewardItem {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ length: 100 })
  name: string; // å•†å“åç§°ï¼Œå¦‚"æ»¡29å‡4ä¼˜æƒ åˆ¸"

  @Column({ type: 'text' })
  description: string; // å•†å“è¯¦ç»†æè¿°

  @Column()
  pointsCost: number; // å…‘æ¢æ‰€éœ€ç§¯åˆ†(5/10/15/20/25/30)

  @Column()
  couponType: string; // ä¼˜æƒ åˆ¸ç±»å‹æ ‡è¯†

  @Column()
  couponValue: number; // ä¼˜æƒ åˆ¸é¢é¢

  @Column()
  conditionAmount: number; // æ»¡å‡ä½¿ç”¨æ¡ä»¶

  @Column()
  stock: number; // åº“å­˜æ•°é‡

  @Column()
  stage: number; // æ‰€å±é˜¶æ®µ(1/2)

  @Column({ default: false })
  isLimited: boolean; // æ˜¯å¦é™é‡å•†å“

  @Column({ default: true })
  isActive: boolean; // æ˜¯å¦æ¿€æ´»çŠ¶æ€

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;
}
```

#### 8. å…‘æ¢è®°å½•è¡¨(RewardRecord)
```typescript
@Entity()
export class RewardRecord {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  userId: string; // å…‘æ¢ç”¨æˆ·ID

  @Column()
  rewardItemId: string; // å…‘æ¢å•†å“ID

  @Column()
  pointsCost: number; // æ¶ˆè€—ç§¯åˆ†

  @Column()
  rewardName: string; // å•†å“åç§°å¿«ç…§

  @Column()
  couponType: string; // ä¼˜æƒ åˆ¸ç±»å‹

  @Column({
    type: 'varchar',
    length: 20,
    default: 'pending'
  })
  status: 'pending' | 'completed' | 'failed'; // å…‘æ¢çŠ¶æ€

  @CreateDateColumn()
  createdAt: Date;
}
```

#### 9. ç”¨æˆ·ä¼˜æƒ åˆ¸è¡¨(UserCoupon)
```typescript
@Entity()
export class UserCoupon {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  userId: string; // æŒæœ‰ç”¨æˆ·ID

  @Column()
  couponType: string; // ä¼˜æƒ åˆ¸ç±»å‹

  @Column()
  couponValue: number; // ä¼˜æƒ åˆ¸é¢é¢

  @Column()
  conditionAmount: number; // ä½¿ç”¨æ¡ä»¶

  @Column()
  source: string; // è·å¾—æ¥æº(ç­¾åˆ°å¥–åŠ±/ç§¯åˆ†å…‘æ¢/å›¢é˜Ÿå¥–åŠ±)

  @Column()
  expiryDate: Date; // è¿‡æœŸæ—¶é—´

  @Column({
    type: 'varchar',
    length: 20,
    default: 'active'
  })
  status: 'active' | 'used' | 'expired'; // ä¼˜æƒ åˆ¸çŠ¶æ€

  @Column({ nullable: true })
  usedAt: Date; // ä½¿ç”¨æ—¶é—´

  @CreateDateColumn()
  createdAt: Date;
}
```

#### 10. ç§¯åˆ†äº¤æ˜“è¡¨(PointsTransaction)
```typescript
@Entity()
export class PointsTransaction {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  userId: string; // ç”¨æˆ·ID

  @Column({
    type: 'varchar',
    length: 20
  })
  type: 'earn' | 'use' | 'expire'; // äº¤æ˜“ç±»å‹

  @Column()
  amount: number; // ç§¯åˆ†æ•°é‡(æ­£æ•°ä¸ºè·å¾—ï¼Œè´Ÿæ•°ä¸ºæ¶ˆè€—)

  @Column()
  description: string; // äº¤æ˜“æè¿°

  @Column({ nullable: true })
  relatedId: string; // å…³è”è®°å½•ID(ç­¾åˆ°è®°å½•/å…‘æ¢è®°å½•ç­‰)

  @Column()
  balanceAfter: number; // äº¤æ˜“åä½™é¢

  @CreateDateColumn()
  createdAt: Date;
}
```

### æ•°æ®åº“å…³ç³»å›¾
```
User (ç”¨æˆ·)
â”œâ”€â”€ 1:1 â†’ PointsAccount (ç§¯åˆ†è´¦æˆ·)
â”œâ”€â”€ 1:N â†’ SignInRecord (ç­¾åˆ°è®°å½•)
â”œâ”€â”€ 1:N â†’ TeamMember (å›¢é˜Ÿæˆå‘˜)
â”œâ”€â”€ 1:N â†’ RewardRecord (å…‘æ¢è®°å½•)
â”œâ”€â”€ 1:N â†’ UserCoupon (ç”¨æˆ·ä¼˜æƒ åˆ¸)
â””â”€â”€ 1:N â†’ PointsTransaction (ç§¯åˆ†äº¤æ˜“)

Team (å›¢é˜Ÿ)
â”œâ”€â”€ 1:N â†’ TeamMember (å›¢é˜Ÿæˆå‘˜)
â””â”€â”€ 1:1 â†’ User (é˜Ÿé•¿)

RewardItem (å¥–åŠ±å•†å“)
â””â”€â”€ 1:N â†’ RewardRecord (å…‘æ¢è®°å½•)

SignInConfig (ç­¾åˆ°é…ç½®)
â””â”€â”€ æŒ‰å‘¨ç®¡ç† â†’ SignInRecord (ç­¾åˆ°è®°å½•)
```

### ç´¢å¼•è®¾è®¡
```sql
-- ç”¨æˆ·è¡¨ç´¢å¼•
CREATE UNIQUE INDEX idx_user_phone ON User(phone);
CREATE INDEX idx_user_created ON User(createdAt);

-- ç§¯åˆ†è´¦æˆ·ç´¢å¼•
CREATE UNIQUE INDEX idx_points_user ON PointsAccount(userId);

-- ç­¾åˆ°è®°å½•ç´¢å¼•
CREATE INDEX idx_signin_user_date ON SignInRecord(userId, signInDate);
CREATE INDEX idx_signin_date ON SignInRecord(signInDate);

-- å›¢é˜Ÿç´¢å¼•
CREATE UNIQUE INDEX idx_team_invite_code ON Team(inviteCode);
CREATE INDEX idx_team_captain ON Team(captainId);
CREATE INDEX idx_team_status ON Team(status);

-- å›¢é˜Ÿæˆå‘˜ç´¢å¼•
CREATE INDEX idx_member_team ON TeamMember(teamId);
CREATE INDEX idx_member_user ON TeamMember(userId);

-- å…‘æ¢è®°å½•ç´¢å¼•
CREATE INDEX idx_reward_user_date ON RewardRecord(userId, createdAt);

-- ç§¯åˆ†äº¤æ˜“ç´¢å¼•
CREATE INDEX idx_transaction_user_date ON PointsTransaction(userId, createdAt);
CREATE INDEX idx_transaction_type ON PointsTransaction(type);
```

## å››ã€ä¸šåŠ¡æµç¨‹è®¾è®¡

### ç”¨æˆ·æ³¨å†Œæµç¨‹
```
ç”¨æˆ·è¾“å…¥æ‰‹æœºå·å’Œå¯†ç 
â†“
å‰ç«¯éªŒè¯æ ¼å¼
â†“
å‘é€æ³¨å†Œè¯·æ±‚
â†“
åç«¯éªŒè¯æ‰‹æœºå·å”¯ä¸€æ€§
â†“
å¯†ç bcryptåŠ å¯†
â†“
åˆ›å»ºç”¨æˆ·è®°å½•
â†“
åˆ›å»ºç§¯åˆ†è´¦æˆ·(åˆå§‹ä½™é¢0)
â†“
è¿”å›æˆåŠŸå“åº”
â†“
è‡ªåŠ¨ç™»å½•è·å–JWT Token
```

### æ¯æ—¥ç­¾åˆ°æµç¨‹
```
ç”¨æˆ·ç‚¹å‡»ç­¾åˆ°
â†“
æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²ç­¾åˆ°
â†“
è·å–æœ¬å‘¨ç­¾åˆ°é…ç½®
â†“
è®¡ç®—å½“æ—¥ç§¯åˆ† = åŸºç¡€ç§¯åˆ† Ã— å½“æ—¥å€æ•°
â†“
æ£€æŸ¥æ˜¯å¦ä¸ºè¿ç»­ç­¾åˆ°å¥–åŠ±æ—¥
â†“
æ›´æ–°ç§¯åˆ†è´¦æˆ·ä½™é¢
â†“
åˆ›å»ºç­¾åˆ°è®°å½•
â†“
åˆ›å»ºç§¯åˆ†äº¤æ˜“è®°å½•
â†“
å¦‚æœæ˜¯å¥–åŠ±æ—¥ï¼Œå‘æ”¾ä¼˜æƒ åˆ¸
â†“
è¿”å›ç­¾åˆ°ç»“æœ
```

### å›¢é˜Ÿç»„é˜Ÿæµç¨‹
```
é˜Ÿé•¿åˆ›å»ºå›¢é˜Ÿ
â†“
ç”Ÿæˆéšæœºé‚€è¯·ç 
â†“
è®¾ç½®å›¢é˜Ÿ3å°æ—¶æœ‰æ•ˆæœŸ
â†“
åˆ†äº«é‚€è¯·ç 
â†“
æˆå‘˜é€šè¿‡é‚€è¯·ç åŠ å…¥
â†“
æ£€æŸ¥å›¢é˜Ÿæ˜¯å¦å·²æ»¡(3äºº)
â†“
æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºæ–°ç”¨æˆ·
â†“
åˆ†é…ç§¯åˆ†ï¼š
- è€ç”¨æˆ·ï¼š100åˆ† Ã· æˆå‘˜æ•°
- æ–°ç”¨æˆ·ï¼šé¢å¤–+10åˆ†
- é˜Ÿé•¿ï¼šå¦‚é‚€è¯·æ–°ç”¨æˆ·+10åˆ†
â†“
è®°å½•å›¢é˜Ÿæˆå‘˜ä¿¡æ¯
â†“
æ›´æ–°ç§¯åˆ†è´¦æˆ·
```

### ç§¯åˆ†å…‘æ¢æµç¨‹
```
ç”¨æˆ·é€‰æ‹©å•†å“
â†“
æ£€æŸ¥ç§¯åˆ†ä½™é¢æ˜¯å¦è¶³å¤Ÿ
â†“
æ£€æŸ¥å•†å“åº“å­˜
â†“
æ£€æŸ¥é˜¶æ®µè§£é”æ¡ä»¶
â†“
æ‰£é™¤ç”¨æˆ·ç§¯åˆ†
â†“
å‡å°‘å•†å“åº“å­˜
â†“
åˆ›å»ºå…‘æ¢è®°å½•
â†“
å‘æ”¾ä¼˜æƒ åˆ¸åˆ°ç”¨æˆ·è´¦æˆ·
â†“
è¿”å›å…‘æ¢ç»“æœ
```

## äº”ã€APIæ¥å£è®¾è®¡

### è®¤è¯ç›¸å…³æ¥å£
```typescript
// ç”¨æˆ·æ³¨å†Œ
POST /api/auth/register
Body: { username: string, phone: string, password: string }
Response: { success: boolean, message: string, data?: UserInfo }

// ç”¨æˆ·ç™»å½•
POST /api/auth/login
Body: { phone: string, password: string }
Response: { success: boolean, token?: string, user?: UserInfo }

// è·å–ç”¨æˆ·ä¿¡æ¯
GET /api/auth/profile
Headers: { Authorization: "Bearer <token>" }
Response: { success: boolean, data?: UserInfo }
```

### ç§¯åˆ†ç³»ç»Ÿæ¥å£
```typescript
// è·å–ç§¯åˆ†è´¦æˆ·
GET /api/points/account
Response: { success: boolean, data?: PointsAccount }

// è·å–æœ¬å‘¨ç­¾åˆ°é…ç½®
GET /api/points/weekly-config
Response: { success: boolean, data?: SignInConfig }

// è·å–ç­¾åˆ°çŠ¶æ€
GET /api/points/signin-status
Response: { 
  success: boolean, 
  data?: { 
    signedToday: boolean,
    signedDays: number[],
    canSignIn: boolean
  }
}

// æ‰§è¡Œç­¾åˆ°
POST /api/points/signin
Response: { 
  success: boolean, 
  data?: { 
    pointsEarned: number,
    newBalance: number,
    isBonus: boolean,
    bonusCoupon?: string
  }
}

// è·å–ç§¯åˆ†è®°å½•
GET /api/points/records?page=1&limit=20&type=earn
Response: { success: boolean, data?: PaginatedResponse<PointsTransaction> }
```

### å›¢é˜Ÿç³»ç»Ÿæ¥å£
```typescript
// åˆ›å»ºå›¢é˜Ÿ
POST /api/team/create
Body: { name: string }
Response: { success: boolean, data?: Team }

// åŠ å…¥å›¢é˜Ÿ
POST /api/team/join
Body: { inviteCode: string }
Response: { success: boolean, data?: TeamMember }

// è·å–æˆ‘çš„å›¢é˜Ÿ
GET /api/team/my-team
Response: { 
  success: boolean, 
  data?: {
    team: Team,
    members: TeamMember[],
    remainingTime: number
  }
}

// åˆ·æ–°é‚€è¯·ç 
PUT /api/team/refresh
Response: { success: boolean, data?: { inviteCode: string } }

// è·å–å›¢é˜Ÿè®°å½•
GET /api/team/records?page=1&limit=20
Response: { success: boolean, data?: PaginatedResponse<TeamRecord> }
```

### å¥–åŠ±ç³»ç»Ÿæ¥å£
```typescript
// è·å–å•†å“åˆ—è¡¨
GET /api/reward/items?stage=1
Response: { success: boolean, data?: RewardItem[] }

// å…‘æ¢å•†å“
POST /api/reward/exchange
Body: { rewardItemId: string }
Response: { 
  success: boolean, 
  data?: { 
    record: RewardRecord,
    newBalance: number,
    coupon: UserCoupon
  }
}

// è·å–å…‘æ¢è®°å½•
GET /api/reward/records?page=1&limit=20
Response: { success: boolean, data?: PaginatedResponse<RewardRecord> }

// è·å–æˆ‘çš„ä¼˜æƒ åˆ¸
GET /api/coupon/my?status=active
Response: { success: boolean, data?: UserCoupon[] }
```

## å…­ã€å‰ç«¯è®¾è®¡è§„èŒƒ

### ç»„ä»¶è®¾è®¡åŸåˆ™
1. **å•ä¸€èŒè´£**: æ¯ä¸ªç»„ä»¶åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
2. **å¯å¤ç”¨æ€§**: ç»„ä»¶åº”è¯¥æ˜“äºåœ¨ä¸åŒåœºæ™¯ä¸­å¤ç”¨
3. **propsæ¥å£**: æ¸…æ™°å®šä¹‰ç»„ä»¶çš„è¾“å…¥è¾“å‡º
4. **çŠ¶æ€ç®¡ç†**: åˆç†ä½¿ç”¨local stateå’Œglobal state

### ç§»åŠ¨ç«¯è®¾è®¡è§„èŒƒ
```typescript
// å®‰å…¨åŒºåŸŸç»„ä»¶
export const SafeArea: React.FC<{ children: React.ReactNode }> = ({ children }) => (
  <div style={{
    paddingTop: 'env(safe-area-inset-top)',
    paddingBottom: 'env(safe-area-inset-bottom)',
    minHeight: '100vh'
  }}>
    {children}
  </div>
);

// ä¸‹æ‹‰åˆ·æ–°ç»„ä»¶
export const PullToRefresh: React.FC<{
  onRefresh: () => Promise<void>;
  children: React.ReactNode;
}> = ({ onRefresh, children }) => {
  // å®ç°ä¸‹æ‹‰åˆ·æ–°é€»è¾‘
};
```

### æ ·å¼ç³»ç»Ÿ
```typescript
// ä¸»é¢˜è‰²å½©
const theme = {
  primary: '#4CAF50',      // ä¸»ç»¿è‰²
  secondary: '#8BC34A',    // æµ…ç»¿è‰²
  accent: '#4facfe',       // è“è‰²æ¸å˜
  warning: '#ff6b6b',      // è­¦å‘Šçº¢è‰²
  background: '#f5f5f5',   // èƒŒæ™¯ç°è‰²
  white: '#ffffff',        // çº¯ç™½è‰²
  text: {
    primary: '#2c3e50',    // ä¸»æ–‡å­—è‰²
    secondary: '#7f8c8d',  // æ¬¡è¦æ–‡å­—è‰²
    light: '#bdc3c7'       // æµ…æ–‡å­—è‰²
  }
};

// å“åº”å¼æ–­ç‚¹
const breakpoints = {
  mobile: '480px',
  tablet: '768px',
  desktop: '1024px'
};
```

### çŠ¶æ€ç®¡ç†è§„èŒƒ
```typescript
// Zustand Storeç¤ºä¾‹
interface AuthState {
  user: User | null;
  token: string | null;
  isLoggedIn: boolean;
  
  // Actions
  login: (token: string, user: User) => void;
  logout: () => void;
  updateUser: (user: Partial<User>) => void;
}

export const useAuthStore = create<AuthState>((set) => ({
  user: null,
  token: localStorage.getItem('token'),
  isLoggedIn: false,
  
  login: (token, user) => {
    localStorage.setItem('token', token);
    set({ token, user, isLoggedIn: true });
  },
  
  logout: () => {
    localStorage.removeItem('token');
    set({ token: null, user: null, isLoggedIn: false });
  },
  
  updateUser: (userData) => set((state) => ({
    user: state.user ? { ...state.user, ...userData } : null
  }))
}));
```

## ä¸ƒã€åç«¯æ¶æ„è®¾è®¡

### Fastifyåº”ç”¨é…ç½®
```typescript
// app.ts
import Fastify from 'fastify';
import cors from '@fastify/cors';
import { authHook } from './middleware/auth.hook.js';

export const createApp = () => {
  const fastify = Fastify({ 
    logger: process.env.NODE_ENV !== 'production',
    trustProxy: true
  });

  // æ³¨å†ŒCORSæ’ä»¶
  fastify.register(cors, {
    origin: process.env.NODE_ENV === 'production' 
      ? ['https://pufen.vercel.app']
      : true,
    credentials: true
  });

  // æ³¨å†Œè®¤è¯ä¸­é—´ä»¶
  fastify.register(authHook);

  // æ³¨å†Œè·¯ç”±
  fastify.register(authRoutes, { prefix: '/api/auth' });
  fastify.register(pointsRoutes, { prefix: '/api/points' });
  fastify.register(teamRoutes, { prefix: '/api/team' });
  fastify.register(rewardRoutes, { prefix: '/api/reward' });

  return fastify;
};
```

### æ§åˆ¶å™¨å±‚è®¾è®¡
```typescript
// points.controller.ts
export const pointsController = {
  // è·å–ç§¯åˆ†è´¦æˆ·
  async getAccount(request: FastifyRequest, reply: FastifyReply) {
    try {
      const userId = request.user.id;
      const account = await pointsService.getPointsAccount(userId);
      
      return reply.code(200).send({
        success: true,
        data: account
      });
    } catch (error) {
      return reply.code(500).send({
        success: false,
        message: 'è·å–ç§¯åˆ†è´¦æˆ·å¤±è´¥'
      });
    }
  },

  // æ‰§è¡Œç­¾åˆ°
  async signIn(request: FastifyRequest, reply: FastifyReply) {
    try {
      const userId = request.user.id;
      const result = await pointsService.performSignIn(userId);
      
      return reply.code(200).send({
        success: true,
        data: result
      });
    } catch (error) {
      return reply.code(400).send({
        success: false,
        message: error.message
      });
    }
  }
};
```

### æœåŠ¡å±‚è®¾è®¡
```typescript
// signin-config.service.ts
export class SignInConfigService {
  // è·å–æˆ–åˆ›å»ºæœ¬å‘¨é…ç½®
  async getOrCreateWeeklyConfig(): Promise<SignInConfig> {
    const weekStart = startOfWeek(new Date(), { weekStartsOn: 1 });
    
    let config = await this.configRepo.findOne({
      where: { weekStartDate: weekStart }
    });

    if (!config) {
      config = await this.createWeeklyConfig(weekStart);
    }

    return config;
  }

  // åˆ›å»ºæ–°çš„å‘¨é…ç½®
  private async createWeeklyConfig(weekStart: Date): Promise<SignInConfig> {
    const config = this.configRepo.create({
      weekStartDate: weekStart,
      basePoints: 10,
      day1Multiplier: 1.0,
      day2Multiplier: Math.random() > 0.5 ? 1.0 : 1.5,
      day3Multiplier: Math.random() > 0.5 ? 1.0 : 1.5,
      day4Multiplier: Math.random() > 0.5 ? 1.0 : 1.5,
      day5Multiplier: Math.random() > 0.5 ? 1.0 : 1.5,
      day6Multiplier: 0.6,
      day7Multiplier: 2.0,
      bonusDay: Math.floor(Math.random() * 3) + 3, // 3-5éšæœº
      bonusCoupon: this.getRandomBonusCoupon()
    });

    return await this.configRepo.save(config);
  }
}
```

### å®šæ—¶ä»»åŠ¡è®¾è®¡
```typescript
// signin.task.ts
import cron from 'node-cron';

// æ¯å‘¨ä¸€å‡Œæ™¨åˆ›å»ºæ–°çš„ç­¾åˆ°é…ç½®
cron.schedule('0 0 * * 1', async () => {
  console.log('å¼€å§‹åˆ›å»ºæ–°çš„å‘¨ç­¾åˆ°é…ç½®...');
  
  try {
    const configService = new SignInConfigService();
    await configService.getOrCreateWeeklyConfig();
    console.log('å‘¨ç­¾åˆ°é…ç½®åˆ›å»ºæˆåŠŸ');
  } catch (error) {
    console.error('åˆ›å»ºå‘¨ç­¾åˆ°é…ç½®å¤±è´¥:', error);
  }
});

// æ¯å¤©å‡Œæ™¨æ¸…ç†è¿‡æœŸå›¢é˜Ÿ
cron.schedule('0 0 * * *', async () => {
  console.log('å¼€å§‹æ¸…ç†è¿‡æœŸå›¢é˜Ÿ...');
  
  try {
    const teamService = new TeamService();
    await teamService.cleanupExpiredTeams();
    console.log('è¿‡æœŸå›¢é˜Ÿæ¸…ç†å®Œæˆ');
  } catch (error) {
    console.error('æ¸…ç†è¿‡æœŸå›¢é˜Ÿå¤±è´¥:', error);
  }
});
```

## å…«ã€éƒ¨ç½²ä¸è¿ç»´

### DockeråŒ–éƒ¨ç½²
```dockerfile
# api/Dockerfile
FROM node:18-alpine

WORKDIR /app

# å¤åˆ¶packageæ–‡ä»¶
COPY package*.json ./
RUN npm ci --only=production

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºTypeScript
RUN npm run build

# åˆ›å»ºæ•°æ®ç›®å½•
RUN mkdir -p /var/data

# æš´éœ²ç«¯å£
EXPOSE 3001

# å¯åŠ¨åº”ç”¨
CMD ["npm", "run", "start:prod"]
```

### ç¯å¢ƒé…ç½®
```bash
# .env.production
NODE_ENV=production
JWT_SECRET=your-super-secure-jwt-secret-key
PORT=3001
DATABASE_PATH=/var/data/pufen.db

# CORSå…è®¸çš„å‰ç«¯åŸŸå
FRONTEND_URL=https://pu-fen-amber.vercel.app

# å®šæ—¶ä»»åŠ¡é…ç½®
ENABLE_CRON_JOBS=true
```

### ç›‘æ§ä¸æ—¥å¿—
```typescript
// åº”ç”¨å¥åº·æ£€æŸ¥
fastify.get('/health', async (request, reply) => {
  try {
    // æ£€æŸ¥æ•°æ®åº“è¿æ¥
    await AppDataSource.query('SELECT 1');
    
    return {
      status: 'ok',
      timestamp: new Date().toISOString(),
      uptime: process.uptime(),
      version: process.env.npm_package_version
    };
  } catch (error) {
    reply.code(503);
    return {
      status: 'error',
      message: 'Database connection failed'
    };
  }
});

// è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
fastify.addHook('onRequest', async (request, reply) => {
  request.startTime = Date.now();
});

fastify.addHook('onResponse', async (request, reply) => {
  const duration = Date.now() - request.startTime;
  console.log(
    `${request.method} ${request.url} ${reply.statusCode} - ${duration}ms`
  );
});
```

### å¤‡ä»½ç­–ç•¥
```bash
#!/bin/bash
# backup.sh - æ•°æ®åº“å¤‡ä»½è„šæœ¬

DATE=$(date +"%Y%m%d_%H%M%S")
BACKUP_DIR="/var/backups/pufen"
DB_PATH="/var/data/pufen.db"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
cp $DB_PATH "$BACKUP_DIR/pufen_$DATE.db"

# å‹ç¼©å¤‡ä»½
gzip "$BACKUP_DIR/pufen_$DATE.db"

# æ¸…ç†è¶…è¿‡7å¤©çš„å¤‡ä»½
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete

echo "æ•°æ®åº“å¤‡ä»½å®Œæˆ: pufen_$DATE.db.gz"
```

## ä¹ã€æ€§èƒ½ä¼˜åŒ–

### å‰ç«¯æ€§èƒ½ä¼˜åŒ–
1. **ä»£ç åˆ†å‰²**: ä½¿ç”¨React.lazy()å’ŒSuspenseè¿›è¡Œè·¯ç”±çº§åˆ«çš„ä»£ç åˆ†å‰²
2. **å›¾ç‰‡ä¼˜åŒ–**: WebPæ ¼å¼ï¼Œå“åº”å¼å›¾ç‰‡ï¼Œæ‡’åŠ è½½
3. **ç¼“å­˜ç­–ç•¥**: Service Workerç¼“å­˜ï¼ŒlocalStorageçŠ¶æ€æŒä¹…åŒ–
4. **Bundleä¼˜åŒ–**: Tree shakingï¼Œä¾èµ–åˆ†æï¼ŒCDNåŠ è½½

### åç«¯æ€§èƒ½ä¼˜åŒ–
1. **æ•°æ®åº“ä¼˜åŒ–**: åˆé€‚çš„ç´¢å¼•ï¼ŒæŸ¥è¯¢ä¼˜åŒ–ï¼Œè¿æ¥æ± 
2. **ç¼“å­˜æœºåˆ¶**: å†…å­˜ç¼“å­˜çƒ­ç‚¹æ•°æ®ï¼ŒRedisé›†ç¾¤(æœªæ¥)
3. **APIä¼˜åŒ–**: åˆ†é¡µæŸ¥è¯¢ï¼Œå­—æ®µé€‰æ‹©ï¼Œæ‰¹é‡æ“ä½œ
4. **å¹¶å‘å¤„ç†**: å¼‚æ­¥IOï¼Œè¿æ¥å¤ç”¨ï¼Œè´Ÿè½½å‡è¡¡

### ç§»åŠ¨ç«¯ä¼˜åŒ–
1. **é¦–å±åŠ è½½**: é¢„åŠ è½½å…³é”®èµ„æºï¼Œå†…è”å…³é”®CSS
2. **è§¦æ‘¸ä¼˜åŒ–**: 300mså»¶è¿Ÿæ¶ˆé™¤ï¼Œè§¦æ‘¸åé¦ˆ
3. **ç½‘ç»œä¼˜åŒ–**: è¯·æ±‚åˆå¹¶ï¼Œç¦»çº¿ç¼“å­˜ï¼Œé¢„åŠ è½½
4. **ç”µæ± ä¼˜åŒ–**: å‡å°‘é‡ç»˜ï¼ŒèŠ‚æµé˜²æŠ–ï¼Œåå°èŠ‚çº¦

## åã€å®‰å…¨è®¾è®¡

### èº«ä»½éªŒè¯å®‰å…¨
```typescript
// JWT Tokené…ç½®
const JWT_OPTIONS = {
  expiresIn: '7d',           // Tokenæœ‰æ•ˆæœŸ
  issuer: 'pufen-app',       // å‘è¡Œè€…
  audience: 'pufen-users'    // å—ä¼—
};

// å¯†ç åŠ å¯†
const BCRYPT_ROUNDS = 12;    // bcryptåŠ å¯†è½®æ•°

// Tokenåˆ·æ–°æœºåˆ¶
export const refreshToken = async (oldToken: string) => {
  try {
    const decoded = jwt.verify(oldToken, JWT_SECRET);
    // ç”Ÿæˆæ–°Token
    return jwt.sign(
      { userId: decoded.userId }, 
      JWT_SECRET, 
      JWT_OPTIONS
    );
  } catch (error) {
    throw new Error('Token refresh failed');
  }
};
```

### æ•°æ®éªŒè¯
```typescript
// è¾“å…¥éªŒè¯schema
const registerSchema = {
  type: 'object',
  required: ['username', 'phone', 'password'],
  properties: {
    username: {
      type: 'string',
      minLength: 2,
      maxLength: 50,
      pattern: '^[\\u4e00-\\u9fa5a-zA-Z0-9_]+$'
    },
    phone: {
      type: 'string',
      pattern: '^1[3-9]\\d{9}$'
    },
    password: {
      type: 'string',
      minLength: 6,
      maxLength: 20
    }
  }
};

// è¯·æ±‚éªŒè¯ä¸­é—´ä»¶
fastify.addSchema({
  $id: 'registerSchema',
  ...registerSchema
});
```

### APIå®‰å…¨é˜²æŠ¤
```typescript
// é¢‘ç‡é™åˆ¶
import rateLimit from '@fastify/rate-limit';

fastify.register(rateLimit, {
  max: 100,                  // æ¯ä¸ªæ—¶é—´çª—å£æœ€å¤§è¯·æ±‚æ•°
  timeWindow: '1 minute',    // æ—¶é—´çª—å£
  skipSuccessfulRequests: false,
  keyGenerator: (request) => request.ip
});

// SQLæ³¨å…¥é˜²æŠ¤
// TypeORMå‚æ•°åŒ–æŸ¥è¯¢è‡ªåŠ¨é˜²æŠ¤

// XSSé˜²æŠ¤
import helmet from '@fastify/helmet';

fastify.register(helmet, {
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"]
    }
  }
});
```

---

*æœ¬æ–‡æ¡£æœ€åæ›´æ–°æ—¶é—´: 2024å¹´12æœˆ*
äºŒã€æ•°æ®æ¨¡å‹
1. ç”¨æˆ·è¡¨(User)
@Entity()
export class User {
  @PrimaryGeneratedColumn('uuid')
  id: string; // ä¸»é”®ï¼Œä½¿ç”¨UUIDè‡ªåŠ¨ç”Ÿæˆï¼Œç¡®ä¿å…¨å±€å”¯ä¸€æ€§

  @Column({ length: 50 })
  username: string; // ç”¨æˆ·æ˜µç§°ï¼Œé™åˆ¶æœ€å¤§é•¿åº¦50å­—ç¬¦ï¼Œç”¨äºæ˜¾ç¤º

  @Column({ length: 20, unique: true })
  phone: string; // ç”¨æˆ·æ‰‹æœºå·ï¼Œé™åˆ¶é•¿åº¦20å­—ç¬¦ï¼Œå”¯ä¸€ç´¢å¼•ç”¨äºç™»å½•

  @Column()
  password: string; // åŠ å¯†åçš„å¯†ç ï¼Œå­˜å‚¨ä½¿ç”¨bcryptåŠ å¯†åçš„å“ˆå¸Œå€¼

  @Column({ default: true })
  isNewUser: boolean; // æ–°ç”¨æˆ·æ ‡è¯†ï¼Œtrueè¡¨ç¤ºæ–°ç”¨æˆ·ï¼Œäº«å—æ–°ç”¨æˆ·æƒç›Š

  @CreateDateColumn()
  createdAt: Date; // è®°å½•åˆ›å»ºæ—¶é—´ï¼Œè‡ªåŠ¨è®¾ç½®ä¸ºè®°å½•æ’å…¥æ—¶é—´

  @UpdateDateColumn()
  updatedAt: Date; // è®°å½•æ›´æ–°æ—¶é—´ï¼Œè‡ªåŠ¨åœ¨è®°å½•å˜æ›´æ—¶æ›´æ–°
}
2. ç§¯åˆ†è´¦æˆ·è¡¨(PointsAccount)
@Entity()
export class PointsAccount {
  @PrimaryGeneratedColumn('uuid')
  id: string; // ä¸»é”®ï¼Œä½¿ç”¨UUIDè‡ªåŠ¨ç”Ÿæˆ

  @Column()
  userId: string; // å…³è”çš„ç”¨æˆ·IDï¼Œä¸Userè¡¨ä¸€å¯¹ä¸€å…³ç³»

  @Column({ default: 0 })
  balance: number; // å½“å‰å¯ç”¨ç§¯åˆ†ä½™é¢ï¼Œé»˜è®¤0

  @Column({ default: 0 })
  totalEarned: number; // ç´¯è®¡è·å¾—ç§¯åˆ†æ€»é¢ï¼Œç»Ÿè®¡ç”¨

  @Column({ default: 0 })
  totalUsed: number; // ç´¯è®¡ä½¿ç”¨ç§¯åˆ†æ€»é¢ï¼Œç»Ÿè®¡ç”¨

  @CreateDateColumn()
  createdAt: Date; // è´¦æˆ·åˆ›å»ºæ—¶é—´

  @UpdateDateColumn()
  updatedAt: Date; // è´¦æˆ·æœ€åæ›´æ–°æ—¶é—´
}
3. ç­¾åˆ°é…ç½®è¡¨(SignInConfig)
@Entity()
export class SignInConfig {
  @PrimaryGeneratedColumn('uuid')
  id: string; // é…ç½®IDï¼Œä¸»é”®

  @Column()
  weekStartDate: Date; // æœ¬å‘¨å¼€å§‹æ—¥æœŸï¼ˆæ¯å‘¨ä¸€ï¼‰

  @Column({ default: 10 })
  basePoints: number; // åŸºç¡€ç§¯åˆ†å€¼ï¼Œå›ºå®š10åˆ†

  @Column({ type: 'float', default: 1.0 })
  day1Multiplier: number; // å‘¨ä¸€ç§¯åˆ†å€æ•°ï¼Œé»˜è®¤1.0ï¼ˆ10åˆ†ï¼‰

  @Column({ type: 'float' })
  day2Multiplier: number; // å‘¨äºŒç§¯åˆ†å€æ•°ï¼Œéšæœº1.0æˆ–1.5

  @Column({ type: 'float' })
  day3Multiplier: number; // å‘¨ä¸‰ç§¯åˆ†å€æ•°ï¼Œéšæœº1.0æˆ–1.5

  @Column({ type: 'float' })
  day4Multiplier: number; // å‘¨å››ç§¯åˆ†å€æ•°ï¼Œéšæœº1.0æˆ–1.5

  @Column({ type: 'float' })
  day5Multiplier: number; // å‘¨äº”ç§¯åˆ†å€æ•°ï¼Œéšæœº1.0æˆ–1.5

  @Column({ type: 'float', default: 0.6 })
  day6Multiplier: number; // å‘¨å…­ç§¯åˆ†å€æ•°ï¼Œå›ºå®š0.6ï¼ˆ6åˆ†ï¼‰

  @Column({ type: 'float', default: 2.0 })
  day7Multiplier: number; // å‘¨æ—¥ç§¯åˆ†å€æ•°ï¼Œå›ºå®š2.0ï¼ˆ20åˆ†ï¼‰

  @Column()
  bonusDay: number; // è¿ç»­ç­¾åˆ°å¥–åŠ±æ—¥ï¼ˆ3-5ä¸­éšæœºä¸€å¤©ï¼‰

  @Column()
  bonusCoupon: string; // è¿ç»­ç­¾åˆ°å¥–åŠ±çš„ä¼˜æƒ åˆ¸ç±»å‹

  @CreateDateColumn()
  createdAt: Date; // é…ç½®åˆ›å»ºæ—¶é—´
}
4. ç­¾åˆ°è®°å½•è¡¨(SignInRecord)
@Entity()
export class SignInRecord {
  @PrimaryGeneratedColumn('uuid')
  id: string; // è®°å½•IDï¼Œä¸»é”®

  @Column()
  userId: string; // å…³è”çš„ç”¨æˆ·ID

  @Column()
  configId: string; // å…³è”çš„ç­¾åˆ°é…ç½®ID

  @Column()
  signInDate: Date; // ç­¾åˆ°æ—¥æœŸï¼ˆå®é™…ç­¾åˆ°æˆ–è¡¥ç­¾çš„æ—¥æœŸï¼‰

  @Column()
  pointsEarned: number; // æœ¬æ¬¡ç­¾åˆ°è·å¾—çš„ç§¯åˆ†æ•°

  @Column({ default: false })
  isMakeUp: boolean; // æ˜¯å¦ä¸ºè¡¥ç­¾è®°å½•

  @Column({ nullable: true })
  makeUpCost: number; // è¡¥ç­¾æ¶ˆè€—çš„ç§¯åˆ†æ•°ï¼ˆ5åˆ†ï¼‰æˆ–æ ‡è®°ä¸º"order"è¡¨ç¤ºé€šè¿‡ä¸‹å•è¡¥ç­¾

  @CreateDateColumn()
  createdAt: Date; // è®°å½•åˆ›å»ºæ—¶é—´
}
5. ç»„é˜Ÿè¡¨(Team)
@Entity()
export class Team {
  @PrimaryGeneratedColumn('uuid')
  id: string; // å›¢é˜ŸIDï¼Œä¸»é”®

  @Column()
  captainId: string; // é˜Ÿé•¿ç”¨æˆ·ID

  @Column({ length: 50 })
  name: string; // å›¢é˜Ÿåç§°ï¼Œæœ€å¤§é•¿åº¦50å­—ç¬¦

  @Column()
  startTime: Date; // å›¢é˜Ÿåˆ›å»º/å¼€å§‹æ—¶é—´

  @Column()
  endTime: Date; // å›¢é˜Ÿç»“æŸæ—¶é—´ï¼ˆå¼€å§‹æ—¶é—´+3å°æ—¶ï¼‰

  @Column({ default: 100 })
  totalPoints: number; // å›¢é˜Ÿæ€»ç§¯åˆ†æ± ï¼Œå›ºå®š100åˆ†

  @Column({ 
    type: 'enum',
    enum: ['active', 'completed', 'expired'],
    default: 'active'
  })
  status: 'active' | 'completed' | 'expired'; // å›¢é˜ŸçŠ¶æ€

  @CreateDateColumn()
  createdAt: Date; // è®°å½•åˆ›å»ºæ—¶é—´
}
6. å›¢é˜Ÿæˆå‘˜è¡¨(TeamMember)
@Entity()
export class TeamMember {
  @PrimaryGeneratedColumn('uuid')
  id: string; // è®°å½•IDï¼Œä¸»é”®

  @Column()
  teamId: string; // å…³è”çš„å›¢é˜ŸID

  @Column()
  userId: string; // å…³è”çš„ç”¨æˆ·ID

  @Column({
    type: 'enum',
    enum: ['captain', 'member']
  })
  role: 'captain' | 'member'; // æˆå‘˜è§’è‰²ï¼šé˜Ÿé•¿æˆ–é˜Ÿå‘˜

  @Column()
  isNewUser: boolean; // åŠ å…¥æ—¶æ˜¯å¦ä¸ºæ–°ç”¨æˆ·

  @Column()
  pointsEarned: number; // è¯¥æˆå‘˜è·å¾—çš„ç§¯åˆ†æ•°

  @Column()
  joinedAt: Date; // åŠ å…¥å›¢é˜Ÿçš„æ—¶é—´
}
7. å…‘æ¢å•†å“è¡¨(RewardItem)
@Entity()
export class RewardItem {
  @PrimaryGeneratedColumn('uuid')
  id: string; // å•†å“IDï¼Œä¸»é”®

  @Column({ length: 100 })
  name: string; // å•†å“åç§°ï¼Œå¦‚"æ»¡29å‡4ä¼˜æƒ åˆ¸"

  @Column({ type: 'text' })
  description: string; // å•†å“è¯¦ç»†æè¿°

  @Column()
  pointsCost: number; // å…‘æ¢æ‰€éœ€ç§¯åˆ†ï¼ˆ5/10/15/20/25/30ï¼‰

  @Column()
  couponType: string; // ä¼˜æƒ åˆ¸ç±»å‹ï¼Œå¦‚"æ»¡29å‡4"

  @Column()
  couponValue: number; // ä¼˜æƒ åˆ¸å®é™…ä¼˜æƒ é‡‘é¢

  @Column()
  conditionAmount: number; // æ»¡å‡æ¡ä»¶é‡‘é¢ï¼ˆå¦‚29å…ƒï¼‰

  @Column()
  stock: number; // åº“å­˜æ•°é‡

  @Column()
  stage: number; // æ‰€å±é˜¶æ®µï¼ˆ1/2ï¼‰

  @Column()
  isLimited: boolean; // æ˜¯å¦é™é‡å…‘æ¢

  @CreateDateColumn()
  createdAt: Date; // å•†å“åˆ›å»ºæ—¶é—´
}
8. å…‘æ¢è®°å½•è¡¨(RewardRecord)
@Entity()
export class RewardRecord {
  @PrimaryGeneratedColumn('uuid')
  id: string; // è®°å½•IDï¼Œä¸»é”®

  @Column()
  userId: string; // å…‘æ¢ç”¨æˆ·ID

  @Column()
  rewardItemId: string; // å…‘æ¢çš„å•†å“ID

  @Column()
  pointsCost: number; // æ¶ˆè€—çš„ç§¯åˆ†æ•°

  @Column()
  couponCode: string; // ç”Ÿæˆçš„ä¼˜æƒ åˆ¸å…‘æ¢ç 

  @Column({
    type: 'enum',
    enum: ['pending', 'completed', 'cancelled'],
    default: 'pending'
  })
  status: 'pending' | 'completed' | 'cancelled'; // å…‘æ¢çŠ¶æ€

  @CreateDateColumn()
  createdAt: Date; // è®°å½•åˆ›å»ºæ—¶é—´
}
9. ç§¯åˆ†æµæ°´è¡¨(PointsTransaction)
@Entity()
export class PointsTransaction {
  @PrimaryGeneratedColumn('uuid')
  id: string; // æµæ°´IDï¼Œä¸»é”®

  @Column()
  userId: string; // å…³è”çš„ç”¨æˆ·ID

  @Column()
  accountId: string; // å…³è”çš„ç§¯åˆ†è´¦æˆ·ID

  @Column()
  amount: number; // ç§¯åˆ†å˜åŠ¨æ•°é‡ï¼ˆæ­£æ•°ä¸ºæ”¶å…¥ï¼Œè´Ÿæ•°ä¸ºæ”¯å‡ºï¼‰

  @Column({
    type: 'enum',
    enum: ['earn', 'use', 'expire']
  })
  type: 'earn' | 'use' | 'expire'; // ç§¯åˆ†å˜åŠ¨ç±»å‹

  @Column({
    type: 'enum',
    enum: ['signin', 'team', 'reward', 'makeup', 'order']
  })
  source: 'signin' | 'team' | 'reward' | 'makeup' | 'order'; // ç§¯åˆ†æ¥æº/å»å‘

  @Column()
  relatedId: string; // å…³è”çš„ä¸šåŠ¡è®°å½•ID

  @Column()
  description: string; // æµæ°´æè¿°ï¼Œå¦‚"å‘¨ä¸€ç­¾åˆ°"ã€"è¡¥ç­¾æ¶ˆè€—"

  @Column()
  balanceBefore: number; // å˜åŠ¨å‰ç§¯åˆ†ä½™é¢

  @Column()
  balanceAfter: number; // å˜åŠ¨åç§¯åˆ†ä½™é¢

  @CreateDateColumn()
  createdAt: Date; // æµæ°´åˆ›å»ºæ—¶é—´
}
ä¸‰ã€è°ƒç”¨æ—¶åº
1. æ¯å‘¨ç­¾åˆ°é…ç½®ç”Ÿæˆ(å®šæ—¶ä»»åŠ¡)
å®šæ—¶ä»»åŠ¡:
  1. æ¯å‘¨ä¸€00:00æ‰§è¡Œ
  2. ç”Ÿæˆæ–°ä¸€å‘¨çš„ç­¾åˆ°é…ç½®:
     - åŸºç¡€ç§¯åˆ†10åˆ†
     - éšæœºé€‰æ‹©ä¸€å¤©(2-5)è®¾ä¸º150%
     - å‘¨å…­å›ºå®š60%ï¼Œå‘¨æ—¥å›ºå®š200%
     - éšæœºé€‰æ‹©å¦ä¸€å¤©(3-5ä¸”â‰ 150%æ—¥)è®¾ä¸ºè¿ç»­ç­¾åˆ°å¥–åŠ±æ—¥
  3. ä¿å­˜åˆ°ç­¾åˆ°é…ç½®è¡¨
2. ç­¾åˆ°æµç¨‹
å‰ç«¯ -> åç«¯: è¯·æ±‚ç­¾åˆ°(ç”¨æˆ·ID)
åç«¯:
  1. æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç­¾åˆ°
  2. è·å–æœ¬å‘¨ç­¾åˆ°é…ç½®
  3. è®¡ç®—ä»Šæ—¥ç§¯åˆ†:
     - åŸºç¡€åˆ† Ã— å½“å¤©å€æ•°
     - æ£€æŸ¥æ˜¯å¦è¿ç»­ç­¾åˆ°åˆ°å¥–åŠ±æ—¥ï¼Œæ˜¯åˆ™æ·»åŠ ä¼˜æƒ åˆ¸
  4. åˆ›å»ºç­¾åˆ°è®°å½•
  5. æ›´æ–°ç”¨æˆ·ç§¯åˆ†è´¦æˆ·
  6. åˆ›å»ºç§¯åˆ†æµæ°´è®°å½•
åç«¯ -> å‰ç«¯: è¿”å›ç­¾åˆ°ç»“æœ(è·å¾—ç§¯åˆ†,è¿ç»­å¤©æ•°,ä¼˜æƒ åˆ¸ç­‰)
3. è¡¥ç­¾æµç¨‹
å‰ç«¯ -> åç«¯: è¯·æ±‚è¡¥ç­¾(ç”¨æˆ·ID,è¡¥ç­¾æ—¥æœŸ,è¡¥ç­¾æ–¹å¼)
åç«¯:
  1. æ£€æŸ¥æœ¬å‘¨æ˜¯å¦å·²è¡¥ç­¾è¿‡
  2. æ£€æŸ¥è¡¥ç­¾æ–¹å¼(æ¶ˆè€—5ç§¯åˆ†æˆ–ä¸‹å•)
  3. è·å–è¡¥ç­¾æ—¥æœŸæ‰€åœ¨å‘¨çš„ç­¾åˆ°é…ç½®
  4. è®¡ç®—åº”å¾—ç§¯åˆ†(åŒæ­£å¸¸ç­¾åˆ°)
  5. åˆ›å»ºè¡¥ç­¾è®°å½•
  6. æ ¹æ®è¡¥ç­¾æ–¹å¼æ‰£é™¤ç§¯åˆ†æˆ–è®°å½•è®¢å•
  7. æ›´æ–°ç”¨æˆ·ç§¯åˆ†è´¦æˆ·
  8. åˆ›å»ºç§¯åˆ†æµæ°´è®°å½•
åç«¯ -> å‰ç«¯: è¿”å›è¡¥ç­¾ç»“æœ
4. ç»„é˜Ÿæµç¨‹
å‰ç«¯ -> åç«¯: è¯·æ±‚åˆ›å»ºå›¢é˜Ÿ(é˜Ÿé•¿ID,å›¢é˜Ÿåç§°)
åç«¯:
  1. åˆ›å»ºå›¢é˜Ÿè®°å½•(è®¾ç½®3å°æ—¶æœ‰æ•ˆæœŸ)
  2. æ·»åŠ é˜Ÿé•¿ä¸ºå›¢é˜Ÿæˆå‘˜(åˆå§‹è·å¾—50ç§¯åˆ†)
  3. åˆ›å»ºç§¯åˆ†æµæ°´è®°å½•
åç«¯ -> å‰ç«¯: è¿”å›å›¢é˜Ÿåˆ›å»ºç»“æœ

å‰ç«¯ -> åç«¯: è¯·æ±‚åŠ å…¥å›¢é˜Ÿ(ç”¨æˆ·ID,å›¢é˜ŸID)
åç«¯:
  1. æ£€æŸ¥å›¢é˜Ÿæ˜¯å¦å¯åŠ å…¥(æœªè¿‡æœŸ,æœªæ»¡å‘˜)
  2. æ·»åŠ ç”¨æˆ·ä¸ºå›¢é˜Ÿæˆå‘˜
  3. è®¡ç®—ç§¯åˆ†åˆ†é…:
     - å¦‚æœæ˜¯æ–°ç”¨æˆ·: é˜Ÿå‘˜å¾—50%Ã—1.5,é˜Ÿé•¿é¢å¤–å¾—50%
     - å¦åˆ™: é˜Ÿå‘˜å¾—50%
  4. æ›´æ–°å›¢é˜Ÿæˆå‘˜ç§¯åˆ†è´¦æˆ·
  5. åˆ›å»ºç§¯åˆ†æµæ°´è®°å½•
åç«¯ -> å‰ç«¯: è¿”å›åŠ å…¥å›¢é˜Ÿç»“æœ
5. å…‘æ¢æµç¨‹
å‰ç«¯ -> åç«¯: è¯·æ±‚å…‘æ¢å•†å“(ç”¨æˆ·ID,å•†å“ID)
åç«¯:
  1. æ£€æŸ¥å•†å“æ˜¯å¦å­˜åœ¨ä¸”å¯å…‘æ¢
  2. æ£€æŸ¥ç”¨æˆ·ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
  3. æ£€æŸ¥å½“å‰é˜¶æ®µæ˜¯å¦å·²è§£é”
  4. åˆ›å»ºå…‘æ¢è®°å½•
  5. æ‰£å‡ç”¨æˆ·ç§¯åˆ†
  6. æ‰£å‡å•†å“åº“å­˜
  7. ç”Ÿæˆä¼˜æƒ åˆ¸ç 
  8. æ£€æŸ¥æ˜¯å¦éœ€è§£é”ä¸‹ä¸€é˜¶æ®µ(å½“å‰é˜¶æ®µå•†å“å…¨éƒ¨å…‘æ¢å®Œ)
  9. åˆ›å»ºç§¯åˆ†æµæ°´è®°å½•
åç«¯ -> å‰ç«¯: è¿”å›å…‘æ¢ç»“æœ(ä¼˜æƒ åˆ¸ç ,æ–°é˜¶æ®µçŠ¶æ€)
6. æŸ¥è¯¢è®°å½•
å‰ç«¯ -> åç«¯: è¯·æ±‚è®°å½•æŸ¥è¯¢(ç”¨æˆ·ID,è®°å½•ç±»å‹,åˆ†é¡µå‚æ•°)
åç«¯:
  1. æ ¹æ®ç±»å‹æŸ¥è¯¢ä¸åŒè®°å½•è¡¨:
     - ç§¯åˆ†è·å–: ç§¯åˆ†æµæ°´è¡¨(type=earn)
     - ç§¯åˆ†å…‘æ¢: å…‘æ¢è®°å½•è¡¨
     - ç»„é˜Ÿè®°å½•: å›¢é˜Ÿæˆå‘˜è¡¨
  2. å…³è”æŸ¥è¯¢æ´»åŠ¨åç§°å’Œè¯¦æƒ…
  3. åˆ†é¡µå¤„ç†ç»“æœ
åç«¯ -> å‰ç«¯: è¿”å›è®°å½•åˆ—è¡¨(å«æ´»åŠ¨åç§°,æ—¶é—´,ç§¯åˆ†å˜åŠ¨ç­‰)
å››ã€UML
ç”¨ä¾‹å›¾
æš‚æ—¶æ— æ³•åœ¨é£ä¹¦æ–‡æ¡£å¤–å±•ç¤ºæ­¤å†…å®¹
ç±»å›¾
æš‚æ—¶æ— æ³•åœ¨é£ä¹¦æ–‡æ¡£å¤–å±•ç¤ºæ­¤å†…å®¹
ERå›¾
äº”ã€å¼€å‘è®¡åˆ’
æš‚æ—¶æ— æ³•åœ¨é£ä¹¦æ–‡æ¡£å¤–å±•ç¤ºæ­¤å†…å®¹
