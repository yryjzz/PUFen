一、技术选型
前端
编码
- 语言：TypeScript
- 框架：React
服务端
编码
- 语言：Nodejs, TypeScript
- 框架：Fastify
数据库
- SQLite
- TypeORM
二、数据模型
1. 用户表(User)
@Entity()
export class User {
  @PrimaryGeneratedColumn('uuid')
  id: string; // 主键，使用UUID自动生成，确保全局唯一性

  @Column({ length: 50 })
  username: string; // 用户昵称，限制最大长度50字符，用于显示

  @Column({ length: 20, unique: true })
  phone: string; // 用户手机号，限制长度20字符，唯一索引用于登录

  @Column()
  password: string; // 加密后的密码，存储使用bcrypt加密后的哈希值

  @Column({ default: true })
  isNewUser: boolean; // 新用户标识，true表示新用户，享受新用户权益

  @CreateDateColumn()
  createdAt: Date; // 记录创建时间，自动设置为记录插入时间

  @UpdateDateColumn()
  updatedAt: Date; // 记录更新时间，自动在记录变更时更新
}
2. 积分账户表(PointsAccount)
@Entity()
export class PointsAccount {
  @PrimaryGeneratedColumn('uuid')
  id: string; // 主键，使用UUID自动生成

  @Column()
  userId: string; // 关联的用户ID，与User表一对一关系

  @Column({ default: 0 })
  balance: number; // 当前可用积分余额，默认0

  @Column({ default: 0 })
  totalEarned: number; // 累计获得积分总额，统计用

  @Column({ default: 0 })
  totalUsed: number; // 累计使用积分总额，统计用

  @CreateDateColumn()
  createdAt: Date; // 账户创建时间

  @UpdateDateColumn()
  updatedAt: Date; // 账户最后更新时间
}
3. 签到配置表(SignInConfig)
@Entity()
export class SignInConfig {
  @PrimaryGeneratedColumn('uuid')
  id: string; // 配置ID，主键

  @Column()
  weekStartDate: Date; // 本周开始日期（每周一）

  @Column({ default: 10 })
  basePoints: number; // 基础积分值，固定10分

  @Column({ type: 'float', default: 1.0 })
  day1Multiplier: number; // 周一积分倍数，默认1.0（10分）

  @Column({ type: 'float' })
  day2Multiplier: number; // 周二积分倍数，随机1.0或1.5

  @Column({ type: 'float' })
  day3Multiplier: number; // 周三积分倍数，随机1.0或1.5

  @Column({ type: 'float' })
  day4Multiplier: number; // 周四积分倍数，随机1.0或1.5

  @Column({ type: 'float' })
  day5Multiplier: number; // 周五积分倍数，随机1.0或1.5

  @Column({ type: 'float', default: 0.6 })
  day6Multiplier: number; // 周六积分倍数，固定0.6（6分）

  @Column({ type: 'float', default: 2.0 })
  day7Multiplier: number; // 周日积分倍数，固定2.0（20分）

  @Column()
  bonusDay: number; // 连续签到奖励日（3-5中随机一天）

  @Column()
  bonusCoupon: string; // 连续签到奖励的优惠券类型

  @CreateDateColumn()
  createdAt: Date; // 配置创建时间
}
4. 签到记录表(SignInRecord)
@Entity()
export class SignInRecord {
  @PrimaryGeneratedColumn('uuid')
  id: string; // 记录ID，主键

  @Column()
  userId: string; // 关联的用户ID

  @Column()
  configId: string; // 关联的签到配置ID

  @Column()
  signInDate: Date; // 签到日期（实际签到或补签的日期）

  @Column()
  pointsEarned: number; // 本次签到获得的积分数

  @Column({ default: false })
  isMakeUp: boolean; // 是否为补签记录

  @Column({ nullable: true })
  makeUpCost: number; // 补签消耗的积分数（5分）或标记为"order"表示通过下单补签

  @CreateDateColumn()
  createdAt: Date; // 记录创建时间
}
5. 组队表(Team)
@Entity()
export class Team {
  @PrimaryGeneratedColumn('uuid')
  id: string; // 团队ID，主键

  @Column()
  captainId: string; // 队长用户ID

  @Column({ length: 50 })
  name: string; // 团队名称，最大长度50字符

  @Column()
  startTime: Date; // 团队创建/开始时间

  @Column()
  endTime: Date; // 团队结束时间（开始时间+3小时）

  @Column({ default: 100 })
  totalPoints: number; // 团队总积分池，固定100分

  @Column({ 
    type: 'enum',
    enum: ['active', 'completed', 'expired'],
    default: 'active'
  })
  status: 'active' | 'completed' | 'expired'; // 团队状态

  @CreateDateColumn()
  createdAt: Date; // 记录创建时间
}
6. 团队成员表(TeamMember)
@Entity()
export class TeamMember {
  @PrimaryGeneratedColumn('uuid')
  id: string; // 记录ID，主键

  @Column()
  teamId: string; // 关联的团队ID

  @Column()
  userId: string; // 关联的用户ID

  @Column({
    type: 'enum',
    enum: ['captain', 'member']
  })
  role: 'captain' | 'member'; // 成员角色：队长或队员

  @Column()
  isNewUser: boolean; // 加入时是否为新用户

  @Column()
  pointsEarned: number; // 该成员获得的积分数

  @Column()
  joinedAt: Date; // 加入团队的时间
}
7. 兑换商品表(RewardItem)
@Entity()
export class RewardItem {
  @PrimaryGeneratedColumn('uuid')
  id: string; // 商品ID，主键

  @Column({ length: 100 })
  name: string; // 商品名称，如"满29减4优惠券"

  @Column({ type: 'text' })
  description: string; // 商品详细描述

  @Column()
  pointsCost: number; // 兑换所需积分（5/10/15/20/25/30）

  @Column()
  couponType: string; // 优惠券类型，如"满29减4"

  @Column()
  couponValue: number; // 优惠券实际优惠金额

  @Column()
  conditionAmount: number; // 满减条件金额（如29元）

  @Column()
  stock: number; // 库存数量

  @Column()
  stage: number; // 所属阶段（1/2）

  @Column()
  isLimited: boolean; // 是否限量兑换

  @CreateDateColumn()
  createdAt: Date; // 商品创建时间
}
8. 兑换记录表(RewardRecord)
@Entity()
export class RewardRecord {
  @PrimaryGeneratedColumn('uuid')
  id: string; // 记录ID，主键

  @Column()
  userId: string; // 兑换用户ID

  @Column()
  rewardItemId: string; // 兑换的商品ID

  @Column()
  pointsCost: number; // 消耗的积分数

  @Column()
  couponCode: string; // 生成的优惠券兑换码

  @Column({
    type: 'enum',
    enum: ['pending', 'completed', 'cancelled'],
    default: 'pending'
  })
  status: 'pending' | 'completed' | 'cancelled'; // 兑换状态

  @CreateDateColumn()
  createdAt: Date; // 记录创建时间
}
9. 积分流水表(PointsTransaction)
@Entity()
export class PointsTransaction {
  @PrimaryGeneratedColumn('uuid')
  id: string; // 流水ID，主键

  @Column()
  userId: string; // 关联的用户ID

  @Column()
  accountId: string; // 关联的积分账户ID

  @Column()
  amount: number; // 积分变动数量（正数为收入，负数为支出）

  @Column({
    type: 'enum',
    enum: ['earn', 'use', 'expire']
  })
  type: 'earn' | 'use' | 'expire'; // 积分变动类型

  @Column({
    type: 'enum',
    enum: ['signin', 'team', 'reward', 'makeup', 'order']
  })
  source: 'signin' | 'team' | 'reward' | 'makeup' | 'order'; // 积分来源/去向

  @Column()
  relatedId: string; // 关联的业务记录ID

  @Column()
  description: string; // 流水描述，如"周一签到"、"补签消耗"

  @Column()
  balanceBefore: number; // 变动前积分余额

  @Column()
  balanceAfter: number; // 变动后积分余额

  @CreateDateColumn()
  createdAt: Date; // 流水创建时间
}
三、调用时序
1. 每周签到配置生成(定时任务)
定时任务:
  1. 每周一00:00执行
  2. 生成新一周的签到配置:
     - 基础积分10分
     - 随机选择一天(2-5)设为150%
     - 周六固定60%，周日固定200%
     - 随机选择另一天(3-5且≠150%日)设为连续签到奖励日
  3. 保存到签到配置表
2. 签到流程
前端 -> 后端: 请求签到(用户ID)
后端:
  1. 检查今天是否已签到
  2. 获取本周签到配置
  3. 计算今日积分:
     - 基础分 × 当天倍数
     - 检查是否连续签到到奖励日，是则添加优惠券
  4. 创建签到记录
  5. 更新用户积分账户
  6. 创建积分流水记录
后端 -> 前端: 返回签到结果(获得积分,连续天数,优惠券等)
3. 补签流程
前端 -> 后端: 请求补签(用户ID,补签日期,补签方式)
后端:
  1. 检查本周是否已补签过
  2. 检查补签方式(消耗5积分或下单)
  3. 获取补签日期所在周的签到配置
  4. 计算应得积分(同正常签到)
  5. 创建补签记录
  6. 根据补签方式扣除积分或记录订单
  7. 更新用户积分账户
  8. 创建积分流水记录
后端 -> 前端: 返回补签结果
4. 组队流程
前端 -> 后端: 请求创建团队(队长ID,团队名称)
后端:
  1. 创建团队记录(设置3小时有效期)
  2. 添加队长为团队成员(初始获得50积分)
  3. 创建积分流水记录
后端 -> 前端: 返回团队创建结果

前端 -> 后端: 请求加入团队(用户ID,团队ID)
后端:
  1. 检查团队是否可加入(未过期,未满员)
  2. 添加用户为团队成员
  3. 计算积分分配:
     - 如果是新用户: 队员得50%×1.5,队长额外得50%
     - 否则: 队员得50%
  4. 更新团队成员积分账户
  5. 创建积分流水记录
后端 -> 前端: 返回加入团队结果
5. 兑换流程
前端 -> 后端: 请求兑换商品(用户ID,商品ID)
后端:
  1. 检查商品是否存在且可兑换
  2. 检查用户积分是否足够
  3. 检查当前阶段是否已解锁
  4. 创建兑换记录
  5. 扣减用户积分
  6. 扣减商品库存
  7. 生成优惠券码
  8. 检查是否需解锁下一阶段(当前阶段商品全部兑换完)
  9. 创建积分流水记录
后端 -> 前端: 返回兑换结果(优惠券码,新阶段状态)
6. 查询记录
前端 -> 后端: 请求记录查询(用户ID,记录类型,分页参数)
后端:
  1. 根据类型查询不同记录表:
     - 积分获取: 积分流水表(type=earn)
     - 积分兑换: 兑换记录表
     - 组队记录: 团队成员表
  2. 关联查询活动名称和详情
  3. 分页处理结果
后端 -> 前端: 返回记录列表(含活动名称,时间,积分变动等)
四、UML
用例图
暂时无法在飞书文档外展示此内容
类图
暂时无法在飞书文档外展示此内容
ER图
五、开发计划
暂时无法在飞书文档外展示此内容
