# PUFen 积分签到系统 - 概要设计文档

### 点击访问👉
- https://pu-fen-amber.vercel.app

## 一、技术选型

### 前端技术栈
**编程语言**
- TypeScript 5.x - 强类型语言，提供更好的开发体验和代码质量

**框架与库**
- React 18 - 现代化前端框架，支持并发特性
- Vite - 快速构建工具，热更新和优化打包
- React Router DOM - 客户端路由管理
- Ant Design - 企业级UI组件库
- Styled Components - CSS-in-JS样式解决方案

**状态管理**
- Zustand - 轻量级状态管理库，简单易用
- React Hooks - 原生状态管理

**工具库**
- Axios - HTTP客户端，API请求处理
- Day.js - 轻量级日期处理库
- React Query (可选) - 服务端状态管理

**移动端优化**
- PWA - 渐进式Web应用
- 触摸事件处理 - 移动端交互优化
- 振动API - 原生体验增强
- Web Share API - 原生分享功能

### 后端技术栈
**编程语言**
- Node.js 18+ - JavaScript运行时
- TypeScript 5.x - 类型安全的服务端开发

**Web框架**
- Fastify 5.x - 高性能Web框架，比Express更快
- Fastify插件生态 - CORS、身份验证等

**数据库**
- SQLite - 轻量级关系型数据库，适合中小型应用
- TypeORM 0.3.x - TypeScript ORM，数据库抽象层

**身份验证**
- JWT (jsonwebtoken) - 无状态身份验证
- bcrypt - 密码加密哈希

**工具库**
- date-fns - 日期处理工具
- node-cron - 定时任务调度
- reflect-metadata - 装饰器元数据支持

### 开发工具
**构建工具**
- tsx - TypeScript执行器
- tsc - TypeScript编译器
- nodemon - 开发热重载

**代码质量**
- ESLint - 代码质量检查
- Prettier - 代码格式化
- TypeScript严格模式 - 类型检查

### 部署架构
**前端部署**
- Vercel - 静态站点托管，自动CI/CD
- CDN加速 - 全球内容分发

**后端部署**
- Render - 容器化部署平台
- Docker - 容器化打包
- 自动扩缩容 - 根据负载自动调整

**数据持久化**
- 文件系统存储 - SQLite数据库文件
- 定期备份 - 数据安全保障

## 二、系统架构设计

### 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端应用        │    │   后端API        │    │   数据库层       │
│   (React SPA)   │◄──►│   (Fastify)     │◄──►│   (SQLite)      │
│                 │    │                 │    │                 │
│ • 用户界面       │    │ • RESTful API   │    │ • 用户数据       │
│ • 状态管理       │    │ • 身份验证       │    │ • 积分记录       │
│ • 路由控制       │    │ • 业务逻辑       │    │ • 签到数据       │
│ • 移动端优化     │    │ • 定时任务       │    │ • 团队信息       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 前端架构
```
src/
├── components/          # 可复用组件
│   ├── mobile.tsx      # 移动端组件(下拉刷新、安全区域)
│   ├── ProtectedRoute.tsx # 路由守卫
│   └── styled.tsx      # 通用样式组件
├── pages/              # 页面组件
│   ├── Login.tsx       # 登录页面
│   ├── Register.tsx    # 注册页面
│   ├── Points.tsx      # 积分主页(签到日历、积分展示)
│   ├── InviteFriend.tsx # 团队邀请页面
│   ├── Records.tsx     # 记录页面(积分、签到、团队记录)
│   ├── Coupons.tsx     # 优惠券页面
│   ├── Rules.tsx       # 规则说明页面
│   ├── Profile.tsx     # 个人中心
│   └── MobileDemo.tsx  # 移动端功能演示
├── services/           # API服务层
│   ├── api.ts         # 基础API配置
│   ├── auth.ts        # 认证相关API
│   ├── points.ts      # 积分相关API
│   ├── team.ts        # 团队相关API
│   ├── reward.ts      # 奖励相关API
│   └── coupon.ts      # 优惠券相关API
├── store/              # 状态管理
│   ├── auth.ts        # 认证状态(用户信息、登录状态)
│   └── points.ts      # 积分状态(积分账户、签到配置)
├── types/              # 类型定义
│   └── index.ts       # 全局类型声明
├── utils/              # 工具函数
│   ├── common.ts      # 通用工具
│   ├── date.ts        # 日期处理
│   ├── mobile.ts      # 移动端工具(设备检测、振动、分享)
│   └── share.ts       # 分享功能
└── styles/             # 样式文件
    ├── mobile.css     # 移动端样式
    └── invite-friend.css # 邀请页面样式
```

### 后端架构
```
src/
├── app.ts              # Fastify应用配置
├── server.ts           # 服务器启动入口
├── config/
│   └── db.ts          # 数据库配置(TypeORM DataSource)
├── controllers/        # 控制器层(处理HTTP请求)
│   ├── auth.controller.ts    # 认证控制器(注册、登录)
│   ├── points.controller.ts  # 积分控制器(账户、记录)
│   ├── signin.controller.ts  # 签到控制器(签到、状态)
│   ├── team.controller.ts    # 团队控制器(创建、加入)
│   ├── reward.controller.ts  # 奖励控制器(商品、兑换)
│   └── coupon.controller.ts  # 优惠券控制器(发放、查询)
├── entities/           # 数据实体(TypeORM Entity)
│   ├── User.ts               # 用户实体
│   ├── PointsAccount.ts      # 积分账户实体
│   ├── SignInRecord.ts       # 签到记录实体
│   ├── SignInConfig.ts       # 签到配置实体
│   ├── Team.ts               # 团队实体
│   ├── TeamMember.ts         # 团队成员实体
│   ├── TeamRecord.ts         # 团队记录实体
│   ├── RewardItem.ts         # 奖励商品实体
│   ├── RewardRecord.ts       # 兑换记录实体
│   ├── UserCoupon.ts         # 用户优惠券实体
│   └── PointsTransaction.ts  # 积分交易实体
├── services/           # 业务逻辑层
│   ├── signin-config.service.ts # 签到配置服务
│   ├── reward-list.service.ts   # 奖励列表服务
│   ├── reward-stage.service.ts  # 奖励阶段服务
│   └── coupon-expiry.service.ts # 优惠券过期服务
├── tasks/              # 定时任务
│   ├── signin.task.ts         # 签到相关定时任务
│   └── coupon-expiry.task.ts  # 优惠券过期任务
├── middleware/         # 中间件
│   └── auth.hook.ts    # 身份验证中间件
├── scripts/            # 脚本工具
│   ├── userCli.ts      # 用户管理脚本
│   ├── coupon-cli.ts   # 优惠券管理脚本
│   └── add-points.ts   # 积分操作脚本
├── types/              # 类型定义
│   └── fastify.d.ts    # Fastify类型扩展
└── utils/              # 工具函数
    ├── jwt.ts          # JWT工具
    └── password.ts     # 密码加密工具
```

## 三、数据库设计

### 数据库选型说明
选择SQLite作为数据库的原因：
1. **轻量级**: 无需独立服务器，降低部署复杂度
2. **高性能**: 对于中小型应用，性能完全满足需求
3. **零配置**: 文件型数据库，易于备份和迁移
4. **事务支持**: 完整的ACID事务支持
5. **成本效益**: 减少数据库服务器成本

### 实体关系设计

#### 1. 用户表(User)
```typescript
@Entity()
export class User {
  @PrimaryGeneratedColumn('uuid')
  id: string; // 主键，UUID确保全局唯一

  @Column({ length: 50 })
  username: string; // 用户昵称，长度限制50字符

  @Column({ length: 20, unique: true })
  phone: string; // 手机号，唯一索引用于登录

  @Column()
  password: string; // bcrypt加密密码

  @Column({ default: true })
  isNewUser: boolean; // 新用户标识，影响团队奖励

  @CreateDateColumn()
  createdAt: Date; // 自动记录创建时间

  @UpdateDateColumn()
  updatedAt: Date; // 自动记录更新时间
}
```

#### 2. 积分账户表(PointsAccount)
```typescript
@Entity()
export class PointsAccount {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  userId: string; // 关联用户ID，一对一关系

  @Column({ default: 0 })
  balance: number; // 当前可用积分余额

  @Column({ default: 0 })
  totalEarned: number; // 历史累计获得积分

  @Column({ default: 0 })
  totalUsed: number; // 历史累计使用积分

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;
}
```

#### 3. 签到配置表(SignInConfig)
```typescript
@Entity()
export class SignInConfig {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  weekStartDate: Date; // 本周开始日期(周一)

  @Column({ default: 10 })
  basePoints: number; // 基础积分，固定10分

  // 每日积分倍数配置
  @Column({ type: 'float', default: 1.0 })
  day1Multiplier: number; // 周一: 1.0倍 (10分)

  @Column({ type: 'float' })
  day2Multiplier: number; // 周二: 1.0或1.5倍随机

  @Column({ type: 'float' })
  day3Multiplier: number; // 周三: 1.0或1.5倍随机

  @Column({ type: 'float' })
  day4Multiplier: number; // 周四: 1.0或1.5倍随机

  @Column({ type: 'float' })
  day5Multiplier: number; // 周五: 1.0或1.5倍随机

  @Column({ type: 'float', default: 0.6 })
  day6Multiplier: number; // 周六: 0.6倍 (6分)

  @Column({ type: 'float', default: 2.0 })
  day7Multiplier: number; // 周日: 2.0倍 (20分)

  @Column()
  bonusDay: number; // 连续签到奖励日(3-5随机)

  @Column()
  bonusCoupon: string; // 奖励优惠券类型

  @CreateDateColumn()
  createdAt: Date;
}
```

#### 4. 签到记录表(SignInRecord)
```typescript
@Entity()
export class SignInRecord {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  userId: string; // 关联用户ID

  @Column()
  signInDate: Date; // 签到日期

  @Column()
  dayOfWeek: number; // 星期几(1-7)

  @Column()
  pointsEarned: number; // 获得的积分

  @Column({ type: 'float' })
  multiplier: number; // 使用的倍数

  @Column({ default: false })
  isBonus: boolean; // 是否为奖励日

  @Column({ default: false })
  isMakeUp: boolean; // 是否为补签

  @Column({ default: 0 })
  makeUpCost: number; // 补签消耗积分

  @CreateDateColumn()
  createdAt: Date;
}
```

#### 5. 团队表(Team)
```typescript
@Entity()
export class Team {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  captainId: string; // 队长用户ID

  @Column({ length: 50 })
  name: string; // 团队名称

  @Column({ length: 10, unique: true, nullable: true })
  inviteCode: string; // 邀请码，10位随机字符

  @Column()
  startTime: Date; // 团队创建时间

  @Column()
  endTime: Date; // 团队结束时间(创建时间+3小时)

  @Column({ default: 100 })
  totalPoints: number; // 总积分池，固定100分

  @Column({
    type: 'varchar',
    length: 20,
    default: 'active'
  })
  status: 'active' | 'completed' | 'expired'; // 团队状态

  @CreateDateColumn()
  createdAt: Date;
}
```

#### 6. 团队成员表(TeamMember)
```typescript
@Entity()
export class TeamMember {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  teamId: string; // 关联团队ID

  @Column()
  userId: string; // 关联用户ID

  @Column({
    type: 'varchar',
    length: 10
  })
  role: 'captain' | 'member'; // 成员角色

  @Column()
  isNewUser: boolean; // 加入时是否为新用户

  @Column()
  pointsEarned: number; // 该成员获得的积分

  @Column()
  joinedAt: Date; // 加入团队时间

  @CreateDateColumn()
  createdAt: Date;
}
```

#### 7. 奖励商品表(RewardItem)
```typescript
@Entity()
export class RewardItem {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ length: 100 })
  name: string; // 商品名称，如"满29减4优惠券"

  @Column({ type: 'text' })
  description: string; // 商品详细描述

  @Column()
  pointsCost: number; // 兑换所需积分(5/10/15/20/25/30)

  @Column()
  couponType: string; // 优惠券类型标识

  @Column()
  couponValue: number; // 优惠券面额

  @Column()
  conditionAmount: number; // 满减使用条件

  @Column()
  stock: number; // 库存数量

  @Column()
  stage: number; // 所属阶段(1/2)

  @Column({ default: false })
  isLimited: boolean; // 是否限量商品

  @Column({ default: true })
  isActive: boolean; // 是否激活状态

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;
}
```

#### 8. 兑换记录表(RewardRecord)
```typescript
@Entity()
export class RewardRecord {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  userId: string; // 兑换用户ID

  @Column()
  rewardItemId: string; // 兑换商品ID

  @Column()
  pointsCost: number; // 消耗积分

  @Column()
  rewardName: string; // 商品名称快照

  @Column()
  couponType: string; // 优惠券类型

  @Column({
    type: 'varchar',
    length: 20,
    default: 'pending'
  })
  status: 'pending' | 'completed' | 'failed'; // 兑换状态

  @CreateDateColumn()
  createdAt: Date;
}
```

#### 9. 用户优惠券表(UserCoupon)
```typescript
@Entity()
export class UserCoupon {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  userId: string; // 持有用户ID

  @Column()
  couponType: string; // 优惠券类型

  @Column()
  couponValue: number; // 优惠券面额

  @Column()
  conditionAmount: number; // 使用条件

  @Column()
  source: string; // 获得来源(签到奖励/积分兑换/团队奖励)

  @Column()
  expiryDate: Date; // 过期时间

  @Column({
    type: 'varchar',
    length: 20,
    default: 'active'
  })
  status: 'active' | 'used' | 'expired'; // 优惠券状态

  @Column({ nullable: true })
  usedAt: Date; // 使用时间

  @CreateDateColumn()
  createdAt: Date;
}
```

#### 10. 积分交易表(PointsTransaction)
```typescript
@Entity()
export class PointsTransaction {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  userId: string; // 用户ID

  @Column({
    type: 'varchar',
    length: 20
  })
  type: 'earn' | 'use' | 'expire'; // 交易类型

  @Column()
  amount: number; // 积分数量(正数为获得，负数为消耗)

  @Column()
  description: string; // 交易描述

  @Column({ nullable: true })
  relatedId: string; // 关联记录ID(签到记录/兑换记录等)

  @Column()
  balanceAfter: number; // 交易后余额

  @CreateDateColumn()
  createdAt: Date;
}
```

### 数据库关系图
```
User (用户)
├── 1:1 → PointsAccount (积分账户)
├── 1:N → SignInRecord (签到记录)
├── 1:N → TeamMember (团队成员)
├── 1:N → RewardRecord (兑换记录)
├── 1:N → UserCoupon (用户优惠券)
└── 1:N → PointsTransaction (积分交易)

Team (团队)
├── 1:N → TeamMember (团队成员)
└── 1:1 → User (队长)

RewardItem (奖励商品)
└── 1:N → RewardRecord (兑换记录)

SignInConfig (签到配置)
└── 按周管理 → SignInRecord (签到记录)
```

### 索引设计
```sql
-- 用户表索引
CREATE UNIQUE INDEX idx_user_phone ON User(phone);
CREATE INDEX idx_user_created ON User(createdAt);

-- 积分账户索引
CREATE UNIQUE INDEX idx_points_user ON PointsAccount(userId);

-- 签到记录索引
CREATE INDEX idx_signin_user_date ON SignInRecord(userId, signInDate);
CREATE INDEX idx_signin_date ON SignInRecord(signInDate);

-- 团队索引
CREATE UNIQUE INDEX idx_team_invite_code ON Team(inviteCode);
CREATE INDEX idx_team_captain ON Team(captainId);
CREATE INDEX idx_team_status ON Team(status);

-- 团队成员索引
CREATE INDEX idx_member_team ON TeamMember(teamId);
CREATE INDEX idx_member_user ON TeamMember(userId);

-- 兑换记录索引
CREATE INDEX idx_reward_user_date ON RewardRecord(userId, createdAt);

-- 积分交易索引
CREATE INDEX idx_transaction_user_date ON PointsTransaction(userId, createdAt);
CREATE INDEX idx_transaction_type ON PointsTransaction(type);
```

## 四、业务流程设计

### 用户注册流程
```
用户输入手机号和密码
↓
前端验证格式
↓
发送注册请求
↓
后端验证手机号唯一性
↓
密码bcrypt加密
↓
创建用户记录
↓
创建积分账户(初始余额0)
↓
返回成功响应
↓
自动登录获取JWT Token
```

### 每日签到流程
```
用户点击签到
↓
检查今日是否已签到
↓
获取本周签到配置
↓
计算当日积分 = 基础积分 × 当日倍数
↓
检查是否为连续签到奖励日
↓
更新积分账户余额
↓
创建签到记录
↓
创建积分交易记录
↓
如果是奖励日，发放优惠券
↓
返回签到结果
```

### 团队组队流程
```
队长创建团队
↓
生成随机邀请码
↓
设置团队3小时有效期
↓
分享邀请码
↓
成员通过邀请码加入
↓
检查团队是否已满(3人)
↓
检查用户是否为新用户
↓
分配积分：
- 老用户：100分 ÷ 成员数
- 新用户：额外+10分
- 队长：如邀请新用户+10分
↓
记录团队成员信息
↓
更新积分账户
```

### 积分兑换流程
```
用户选择商品
↓
检查积分余额是否足够
↓
检查商品库存
↓
检查阶段解锁条件
↓
扣除用户积分
↓
减少商品库存
↓
创建兑换记录
↓
发放优惠券到用户账户
↓
返回兑换结果
```

## 五、API接口设计

### 认证相关接口
```typescript
// 用户注册
POST /api/auth/register
Body: { username: string, phone: string, password: string }
Response: { success: boolean, message: string, data?: UserInfo }

// 用户登录
POST /api/auth/login
Body: { phone: string, password: string }
Response: { success: boolean, token?: string, user?: UserInfo }

// 获取用户信息
GET /api/auth/profile
Headers: { Authorization: "Bearer <token>" }
Response: { success: boolean, data?: UserInfo }
```

### 积分系统接口
```typescript
// 获取积分账户
GET /api/points/account
Response: { success: boolean, data?: PointsAccount }

// 获取本周签到配置
GET /api/points/weekly-config
Response: { success: boolean, data?: SignInConfig }

// 获取签到状态
GET /api/points/signin-status
Response: { 
  success: boolean, 
  data?: { 
    signedToday: boolean,
    signedDays: number[],
    canSignIn: boolean
  }
}

// 执行签到
POST /api/points/signin
Response: { 
  success: boolean, 
  data?: { 
    pointsEarned: number,
    newBalance: number,
    isBonus: boolean,
    bonusCoupon?: string
  }
}

// 获取积分记录
GET /api/points/records?page=1&limit=20&type=earn
Response: { success: boolean, data?: PaginatedResponse<PointsTransaction> }
```

### 团队系统接口
```typescript
// 创建团队
POST /api/team/create
Body: { name: string }
Response: { success: boolean, data?: Team }

// 加入团队
POST /api/team/join
Body: { inviteCode: string }
Response: { success: boolean, data?: TeamMember }

// 获取我的团队
GET /api/team/my-team
Response: { 
  success: boolean, 
  data?: {
    team: Team,
    members: TeamMember[],
    remainingTime: number
  }
}

// 刷新邀请码
PUT /api/team/refresh
Response: { success: boolean, data?: { inviteCode: string } }

// 获取团队记录
GET /api/team/records?page=1&limit=20
Response: { success: boolean, data?: PaginatedResponse<TeamRecord> }
```

### 奖励系统接口
```typescript
// 获取商品列表
GET /api/reward/items?stage=1
Response: { success: boolean, data?: RewardItem[] }

// 兑换商品
POST /api/reward/exchange
Body: { rewardItemId: string }
Response: { 
  success: boolean, 
  data?: { 
    record: RewardRecord,
    newBalance: number,
    coupon: UserCoupon
  }
}

// 获取兑换记录
GET /api/reward/records?page=1&limit=20
Response: { success: boolean, data?: PaginatedResponse<RewardRecord> }

// 获取我的优惠券
GET /api/coupon/my?status=active
Response: { success: boolean, data?: UserCoupon[] }
```

## 六、前端设计规范

### 组件设计原则
1. **单一职责**: 每个组件只负责一个功能
2. **可复用性**: 组件应该易于在不同场景中复用
3. **props接口**: 清晰定义组件的输入输出
4. **状态管理**: 合理使用local state和global state

### 移动端设计规范
```typescript
// 安全区域组件
export const SafeArea: React.FC<{ children: React.ReactNode }> = ({ children }) => (
  <div style={{
    paddingTop: 'env(safe-area-inset-top)',
    paddingBottom: 'env(safe-area-inset-bottom)',
    minHeight: '100vh'
  }}>
    {children}
  </div>
);

// 下拉刷新组件
export const PullToRefresh: React.FC<{
  onRefresh: () => Promise<void>;
  children: React.ReactNode;
}> = ({ onRefresh, children }) => {
  // 实现下拉刷新逻辑
};
```

### 样式系统
```typescript
// 主题色彩
const theme = {
  primary: '#4CAF50',      // 主绿色
  secondary: '#8BC34A',    // 浅绿色
  accent: '#4facfe',       // 蓝色渐变
  warning: '#ff6b6b',      // 警告红色
  background: '#f5f5f5',   // 背景灰色
  white: '#ffffff',        // 纯白色
  text: {
    primary: '#2c3e50',    // 主文字色
    secondary: '#7f8c8d',  // 次要文字色
    light: '#bdc3c7'       // 浅文字色
  }
};

// 响应式断点
const breakpoints = {
  mobile: '480px',
  tablet: '768px',
  desktop: '1024px'
};
```

### 状态管理规范
```typescript
// Zustand Store示例
interface AuthState {
  user: User | null;
  token: string | null;
  isLoggedIn: boolean;
  
  // Actions
  login: (token: string, user: User) => void;
  logout: () => void;
  updateUser: (user: Partial<User>) => void;
}

export const useAuthStore = create<AuthState>((set) => ({
  user: null,
  token: localStorage.getItem('token'),
  isLoggedIn: false,
  
  login: (token, user) => {
    localStorage.setItem('token', token);
    set({ token, user, isLoggedIn: true });
  },
  
  logout: () => {
    localStorage.removeItem('token');
    set({ token: null, user: null, isLoggedIn: false });
  },
  
  updateUser: (userData) => set((state) => ({
    user: state.user ? { ...state.user, ...userData } : null
  }))
}));
```

## 七、后端架构设计

### Fastify应用配置
```typescript
// app.ts
import Fastify from 'fastify';
import cors from '@fastify/cors';
import { authHook } from './middleware/auth.hook.js';

export const createApp = () => {
  const fastify = Fastify({ 
    logger: process.env.NODE_ENV !== 'production',
    trustProxy: true
  });

  // 注册CORS插件
  fastify.register(cors, {
    origin: process.env.NODE_ENV === 'production' 
      ? ['https://pufen.vercel.app']
      : true,
    credentials: true
  });

  // 注册认证中间件
  fastify.register(authHook);

  // 注册路由
  fastify.register(authRoutes, { prefix: '/api/auth' });
  fastify.register(pointsRoutes, { prefix: '/api/points' });
  fastify.register(teamRoutes, { prefix: '/api/team' });
  fastify.register(rewardRoutes, { prefix: '/api/reward' });

  return fastify;
};
```

### 控制器层设计
```typescript
// points.controller.ts
export const pointsController = {
  // 获取积分账户
  async getAccount(request: FastifyRequest, reply: FastifyReply) {
    try {
      const userId = request.user.id;
      const account = await pointsService.getPointsAccount(userId);
      
      return reply.code(200).send({
        success: true,
        data: account
      });
    } catch (error) {
      return reply.code(500).send({
        success: false,
        message: '获取积分账户失败'
      });
    }
  },

  // 执行签到
  async signIn(request: FastifyRequest, reply: FastifyReply) {
    try {
      const userId = request.user.id;
      const result = await pointsService.performSignIn(userId);
      
      return reply.code(200).send({
        success: true,
        data: result
      });
    } catch (error) {
      return reply.code(400).send({
        success: false,
        message: error.message
      });
    }
  }
};
```

### 服务层设计
```typescript
// signin-config.service.ts
export class SignInConfigService {
  // 获取或创建本周配置
  async getOrCreateWeeklyConfig(): Promise<SignInConfig> {
    const weekStart = startOfWeek(new Date(), { weekStartsOn: 1 });
    
    let config = await this.configRepo.findOne({
      where: { weekStartDate: weekStart }
    });

    if (!config) {
      config = await this.createWeeklyConfig(weekStart);
    }

    return config;
  }

  // 创建新的周配置
  private async createWeeklyConfig(weekStart: Date): Promise<SignInConfig> {
    const config = this.configRepo.create({
      weekStartDate: weekStart,
      basePoints: 10,
      day1Multiplier: 1.0,
      day2Multiplier: Math.random() > 0.5 ? 1.0 : 1.5,
      day3Multiplier: Math.random() > 0.5 ? 1.0 : 1.5,
      day4Multiplier: Math.random() > 0.5 ? 1.0 : 1.5,
      day5Multiplier: Math.random() > 0.5 ? 1.0 : 1.5,
      day6Multiplier: 0.6,
      day7Multiplier: 2.0,
      bonusDay: Math.floor(Math.random() * 3) + 3, // 3-5随机
      bonusCoupon: this.getRandomBonusCoupon()
    });

    return await this.configRepo.save(config);
  }
}
```

### 定时任务设计
```typescript
// signin.task.ts
import cron from 'node-cron';

// 每周一凌晨创建新的签到配置
cron.schedule('0 0 * * 1', async () => {
  console.log('开始创建新的周签到配置...');
  
  try {
    const configService = new SignInConfigService();
    await configService.getOrCreateWeeklyConfig();
    console.log('周签到配置创建成功');
  } catch (error) {
    console.error('创建周签到配置失败:', error);
  }
});

// 每天凌晨清理过期团队
cron.schedule('0 0 * * *', async () => {
  console.log('开始清理过期团队...');
  
  try {
    const teamService = new TeamService();
    await teamService.cleanupExpiredTeams();
    console.log('过期团队清理完成');
  } catch (error) {
    console.error('清理过期团队失败:', error);
  }
});
```

## 八、部署与运维

### Docker化部署
```dockerfile
# api/Dockerfile
FROM node:18-alpine

WORKDIR /app

# 复制package文件
COPY package*.json ./
RUN npm ci --only=production

# 复制源代码
COPY . .

# 构建TypeScript
RUN npm run build

# 创建数据目录
RUN mkdir -p /var/data

# 暴露端口
EXPOSE 3001

# 启动应用
CMD ["npm", "run", "start:prod"]
```

### 环境配置
```bash
# .env.production
NODE_ENV=production
JWT_SECRET=your-super-secure-jwt-secret-key
PORT=3001
DATABASE_PATH=/var/data/pufen.db

# CORS允许的前端域名
FRONTEND_URL=https://pu-fen-amber.vercel.app

# 定时任务配置
ENABLE_CRON_JOBS=true
```

### 监控与日志
```typescript
// 应用健康检查
fastify.get('/health', async (request, reply) => {
  try {
    // 检查数据库连接
    await AppDataSource.query('SELECT 1');
    
    return {
      status: 'ok',
      timestamp: new Date().toISOString(),
      uptime: process.uptime(),
      version: process.env.npm_package_version
    };
  } catch (error) {
    reply.code(503);
    return {
      status: 'error',
      message: 'Database connection failed'
    };
  }
});

// 请求日志中间件
fastify.addHook('onRequest', async (request, reply) => {
  request.startTime = Date.now();
});

fastify.addHook('onResponse', async (request, reply) => {
  const duration = Date.now() - request.startTime;
  console.log(
    `${request.method} ${request.url} ${reply.statusCode} - ${duration}ms`
  );
});
```

### 备份策略
```bash
#!/bin/bash
# backup.sh - 数据库备份脚本

DATE=$(date +"%Y%m%d_%H%M%S")
BACKUP_DIR="/var/backups/pufen"
DB_PATH="/var/data/pufen.db"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
cp $DB_PATH "$BACKUP_DIR/pufen_$DATE.db"

# 压缩备份
gzip "$BACKUP_DIR/pufen_$DATE.db"

# 清理超过7天的备份
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete

echo "数据库备份完成: pufen_$DATE.db.gz"
```

## 九、性能优化

### 前端性能优化
1. **代码分割**: 使用React.lazy()和Suspense进行路由级别的代码分割
2. **图片优化**: WebP格式，响应式图片，懒加载
3. **缓存策略**: Service Worker缓存，localStorage状态持久化
4. **Bundle优化**: Tree shaking，依赖分析，CDN加载

### 后端性能优化
1. **数据库优化**: 合适的索引，查询优化，连接池
2. **缓存机制**: 内存缓存热点数据，Redis集群(未来)
3. **API优化**: 分页查询，字段选择，批量操作
4. **并发处理**: 异步IO，连接复用，负载均衡

### 移动端优化
1. **首屏加载**: 预加载关键资源，内联关键CSS
2. **触摸优化**: 300ms延迟消除，触摸反馈
3. **网络优化**: 请求合并，离线缓存，预加载
4. **电池优化**: 减少重绘，节流防抖，后台节约

## 十、安全设计

### 身份验证安全
```typescript
// JWT Token配置
const JWT_OPTIONS = {
  expiresIn: '7d',           // Token有效期
  issuer: 'pufen-app',       // 发行者
  audience: 'pufen-users'    // 受众
};

// 密码加密
const BCRYPT_ROUNDS = 12;    // bcrypt加密轮数

// Token刷新机制
export const refreshToken = async (oldToken: string) => {
  try {
    const decoded = jwt.verify(oldToken, JWT_SECRET);
    // 生成新Token
    return jwt.sign(
      { userId: decoded.userId }, 
      JWT_SECRET, 
      JWT_OPTIONS
    );
  } catch (error) {
    throw new Error('Token refresh failed');
  }
};
```

### 数据验证
```typescript
// 输入验证schema
const registerSchema = {
  type: 'object',
  required: ['username', 'phone', 'password'],
  properties: {
    username: {
      type: 'string',
      minLength: 2,
      maxLength: 50,
      pattern: '^[\\u4e00-\\u9fa5a-zA-Z0-9_]+$'
    },
    phone: {
      type: 'string',
      pattern: '^1[3-9]\\d{9}$'
    },
    password: {
      type: 'string',
      minLength: 6,
      maxLength: 20
    }
  }
};

// 请求验证中间件
fastify.addSchema({
  $id: 'registerSchema',
  ...registerSchema
});
```

### API安全防护
```typescript
// 频率限制
import rateLimit from '@fastify/rate-limit';

fastify.register(rateLimit, {
  max: 100,                  // 每个时间窗口最大请求数
  timeWindow: '1 minute',    // 时间窗口
  skipSuccessfulRequests: false,
  keyGenerator: (request) => request.ip
});

// SQL注入防护
// TypeORM参数化查询自动防护

// XSS防护
import helmet from '@fastify/helmet';

fastify.register(helmet, {
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"]
    }
  }
});
```

---

*本文档最后更新时间: 2024年12月*
二、数据模型
1. 用户表(User)
@Entity()
export class User {
  @PrimaryGeneratedColumn('uuid')
  id: string; // 主键，使用UUID自动生成，确保全局唯一性

  @Column({ length: 50 })
  username: string; // 用户昵称，限制最大长度50字符，用于显示

  @Column({ length: 20, unique: true })
  phone: string; // 用户手机号，限制长度20字符，唯一索引用于登录

  @Column()
  password: string; // 加密后的密码，存储使用bcrypt加密后的哈希值

  @Column({ default: true })
  isNewUser: boolean; // 新用户标识，true表示新用户，享受新用户权益

  @CreateDateColumn()
  createdAt: Date; // 记录创建时间，自动设置为记录插入时间

  @UpdateDateColumn()
  updatedAt: Date; // 记录更新时间，自动在记录变更时更新
}
2. 积分账户表(PointsAccount)
@Entity()
export class PointsAccount {
  @PrimaryGeneratedColumn('uuid')
  id: string; // 主键，使用UUID自动生成

  @Column()
  userId: string; // 关联的用户ID，与User表一对一关系

  @Column({ default: 0 })
  balance: number; // 当前可用积分余额，默认0

  @Column({ default: 0 })
  totalEarned: number; // 累计获得积分总额，统计用

  @Column({ default: 0 })
  totalUsed: number; // 累计使用积分总额，统计用

  @CreateDateColumn()
  createdAt: Date; // 账户创建时间

  @UpdateDateColumn()
  updatedAt: Date; // 账户最后更新时间
}
3. 签到配置表(SignInConfig)
@Entity()
export class SignInConfig {
  @PrimaryGeneratedColumn('uuid')
  id: string; // 配置ID，主键

  @Column()
  weekStartDate: Date; // 本周开始日期（每周一）

  @Column({ default: 10 })
  basePoints: number; // 基础积分值，固定10分

  @Column({ type: 'float', default: 1.0 })
  day1Multiplier: number; // 周一积分倍数，默认1.0（10分）

  @Column({ type: 'float' })
  day2Multiplier: number; // 周二积分倍数，随机1.0或1.5

  @Column({ type: 'float' })
  day3Multiplier: number; // 周三积分倍数，随机1.0或1.5

  @Column({ type: 'float' })
  day4Multiplier: number; // 周四积分倍数，随机1.0或1.5

  @Column({ type: 'float' })
  day5Multiplier: number; // 周五积分倍数，随机1.0或1.5

  @Column({ type: 'float', default: 0.6 })
  day6Multiplier: number; // 周六积分倍数，固定0.6（6分）

  @Column({ type: 'float', default: 2.0 })
  day7Multiplier: number; // 周日积分倍数，固定2.0（20分）

  @Column()
  bonusDay: number; // 连续签到奖励日（3-5中随机一天）

  @Column()
  bonusCoupon: string; // 连续签到奖励的优惠券类型

  @CreateDateColumn()
  createdAt: Date; // 配置创建时间
}
4. 签到记录表(SignInRecord)
@Entity()
export class SignInRecord {
  @PrimaryGeneratedColumn('uuid')
  id: string; // 记录ID，主键

  @Column()
  userId: string; // 关联的用户ID

  @Column()
  configId: string; // 关联的签到配置ID

  @Column()
  signInDate: Date; // 签到日期（实际签到或补签的日期）

  @Column()
  pointsEarned: number; // 本次签到获得的积分数

  @Column({ default: false })
  isMakeUp: boolean; // 是否为补签记录

  @Column({ nullable: true })
  makeUpCost: number; // 补签消耗的积分数（5分）或标记为"order"表示通过下单补签

  @CreateDateColumn()
  createdAt: Date; // 记录创建时间
}
5. 组队表(Team)
@Entity()
export class Team {
  @PrimaryGeneratedColumn('uuid')
  id: string; // 团队ID，主键

  @Column()
  captainId: string; // 队长用户ID

  @Column({ length: 50 })
  name: string; // 团队名称，最大长度50字符

  @Column()
  startTime: Date; // 团队创建/开始时间

  @Column()
  endTime: Date; // 团队结束时间（开始时间+3小时）

  @Column({ default: 100 })
  totalPoints: number; // 团队总积分池，固定100分

  @Column({ 
    type: 'enum',
    enum: ['active', 'completed', 'expired'],
    default: 'active'
  })
  status: 'active' | 'completed' | 'expired'; // 团队状态

  @CreateDateColumn()
  createdAt: Date; // 记录创建时间
}
6. 团队成员表(TeamMember)
@Entity()
export class TeamMember {
  @PrimaryGeneratedColumn('uuid')
  id: string; // 记录ID，主键

  @Column()
  teamId: string; // 关联的团队ID

  @Column()
  userId: string; // 关联的用户ID

  @Column({
    type: 'enum',
    enum: ['captain', 'member']
  })
  role: 'captain' | 'member'; // 成员角色：队长或队员

  @Column()
  isNewUser: boolean; // 加入时是否为新用户

  @Column()
  pointsEarned: number; // 该成员获得的积分数

  @Column()
  joinedAt: Date; // 加入团队的时间
}
7. 兑换商品表(RewardItem)
@Entity()
export class RewardItem {
  @PrimaryGeneratedColumn('uuid')
  id: string; // 商品ID，主键

  @Column({ length: 100 })
  name: string; // 商品名称，如"满29减4优惠券"

  @Column({ type: 'text' })
  description: string; // 商品详细描述

  @Column()
  pointsCost: number; // 兑换所需积分（5/10/15/20/25/30）

  @Column()
  couponType: string; // 优惠券类型，如"满29减4"

  @Column()
  couponValue: number; // 优惠券实际优惠金额

  @Column()
  conditionAmount: number; // 满减条件金额（如29元）

  @Column()
  stock: number; // 库存数量

  @Column()
  stage: number; // 所属阶段（1/2）

  @Column()
  isLimited: boolean; // 是否限量兑换

  @CreateDateColumn()
  createdAt: Date; // 商品创建时间
}
8. 兑换记录表(RewardRecord)
@Entity()
export class RewardRecord {
  @PrimaryGeneratedColumn('uuid')
  id: string; // 记录ID，主键

  @Column()
  userId: string; // 兑换用户ID

  @Column()
  rewardItemId: string; // 兑换的商品ID

  @Column()
  pointsCost: number; // 消耗的积分数

  @Column()
  couponCode: string; // 生成的优惠券兑换码

  @Column({
    type: 'enum',
    enum: ['pending', 'completed', 'cancelled'],
    default: 'pending'
  })
  status: 'pending' | 'completed' | 'cancelled'; // 兑换状态

  @CreateDateColumn()
  createdAt: Date; // 记录创建时间
}
9. 积分流水表(PointsTransaction)
@Entity()
export class PointsTransaction {
  @PrimaryGeneratedColumn('uuid')
  id: string; // 流水ID，主键

  @Column()
  userId: string; // 关联的用户ID

  @Column()
  accountId: string; // 关联的积分账户ID

  @Column()
  amount: number; // 积分变动数量（正数为收入，负数为支出）

  @Column({
    type: 'enum',
    enum: ['earn', 'use', 'expire']
  })
  type: 'earn' | 'use' | 'expire'; // 积分变动类型

  @Column({
    type: 'enum',
    enum: ['signin', 'team', 'reward', 'makeup', 'order']
  })
  source: 'signin' | 'team' | 'reward' | 'makeup' | 'order'; // 积分来源/去向

  @Column()
  relatedId: string; // 关联的业务记录ID

  @Column()
  description: string; // 流水描述，如"周一签到"、"补签消耗"

  @Column()
  balanceBefore: number; // 变动前积分余额

  @Column()
  balanceAfter: number; // 变动后积分余额

  @CreateDateColumn()
  createdAt: Date; // 流水创建时间
}
三、调用时序
1. 每周签到配置生成(定时任务)
定时任务:
  1. 每周一00:00执行
  2. 生成新一周的签到配置:
     - 基础积分10分
     - 随机选择一天(2-5)设为150%
     - 周六固定60%，周日固定200%
     - 随机选择另一天(3-5且≠150%日)设为连续签到奖励日
  3. 保存到签到配置表
2. 签到流程
前端 -> 后端: 请求签到(用户ID)
后端:
  1. 检查今天是否已签到
  2. 获取本周签到配置
  3. 计算今日积分:
     - 基础分 × 当天倍数
     - 检查是否连续签到到奖励日，是则添加优惠券
  4. 创建签到记录
  5. 更新用户积分账户
  6. 创建积分流水记录
后端 -> 前端: 返回签到结果(获得积分,连续天数,优惠券等)
3. 补签流程
前端 -> 后端: 请求补签(用户ID,补签日期,补签方式)
后端:
  1. 检查本周是否已补签过
  2. 检查补签方式(消耗5积分或下单)
  3. 获取补签日期所在周的签到配置
  4. 计算应得积分(同正常签到)
  5. 创建补签记录
  6. 根据补签方式扣除积分或记录订单
  7. 更新用户积分账户
  8. 创建积分流水记录
后端 -> 前端: 返回补签结果
4. 组队流程
前端 -> 后端: 请求创建团队(队长ID,团队名称)
后端:
  1. 创建团队记录(设置3小时有效期)
  2. 添加队长为团队成员(初始获得50积分)
  3. 创建积分流水记录
后端 -> 前端: 返回团队创建结果

前端 -> 后端: 请求加入团队(用户ID,团队ID)
后端:
  1. 检查团队是否可加入(未过期,未满员)
  2. 添加用户为团队成员
  3. 计算积分分配:
     - 如果是新用户: 队员得50%×1.5,队长额外得50%
     - 否则: 队员得50%
  4. 更新团队成员积分账户
  5. 创建积分流水记录
后端 -> 前端: 返回加入团队结果
5. 兑换流程
前端 -> 后端: 请求兑换商品(用户ID,商品ID)
后端:
  1. 检查商品是否存在且可兑换
  2. 检查用户积分是否足够
  3. 检查当前阶段是否已解锁
  4. 创建兑换记录
  5. 扣减用户积分
  6. 扣减商品库存
  7. 生成优惠券码
  8. 检查是否需解锁下一阶段(当前阶段商品全部兑换完)
  9. 创建积分流水记录
后端 -> 前端: 返回兑换结果(优惠券码,新阶段状态)
6. 查询记录
前端 -> 后端: 请求记录查询(用户ID,记录类型,分页参数)
后端:
  1. 根据类型查询不同记录表:
     - 积分获取: 积分流水表(type=earn)
     - 积分兑换: 兑换记录表
     - 组队记录: 团队成员表
  2. 关联查询活动名称和详情
  3. 分页处理结果
后端 -> 前端: 返回记录列表(含活动名称,时间,积分变动等)
四、UML
用例图
暂时无法在飞书文档外展示此内容
类图
暂时无法在飞书文档外展示此内容
ER图
五、开发计划
暂时无法在飞书文档外展示此内容
